
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Plac: Parsing the Command Line the Easy Way &#8212; plac  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="plac-parsing-the-command-line-the-easy-way">
<h1><a class="toc-backref" href="#id6">Plac: Parsing the Command Line the Easy Way</a><a class="headerlink" href="#plac-parsing-the-command-line-the-easy-way" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Michele Simionato</p>
</dd>
<dt class="field-even">E-mail</dt>
<dd class="field-even"><p><a class="reference external" href="mailto:michele&#46;simionato&#37;&#52;&#48;gmail&#46;com">michele<span>&#46;</span>simionato<span>&#64;</span>gmail<span>&#46;</span>com</a></p>
</dd>
<dt class="field-odd">Version</dt>
<dd class="field-odd"><p>1.2.0</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>June 2020</p>
</dd>
<dt class="field-odd">Download page</dt>
<dd class="field-odd"><p><a class="reference external" href="http://pypi.python.org/pypi/plac">http://pypi.python.org/pypi/plac</a></p>
</dd>
<dt class="field-even">Project page</dt>
<dd class="field-even"><p><a class="reference external" href="https://github.com/micheles/plac">https://github.com/micheles/plac</a></p>
</dd>
<dt class="field-odd">Requires</dt>
<dd class="field-odd"><p>Python from 2.6 to 3.8</p>
</dd>
<dt class="field-even">Installation</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">plac</span></code></p>
</dd>
<dt class="field-odd">License</dt>
<dd class="field-odd"><p>BSD license</p>
</dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#plac-parsing-the-command-line-the-easy-way" id="id6">Plac: Parsing the Command Line the Easy Way</a></p>
<ul>
<li><p><a class="reference internal" href="#for-the-impatient" id="id7">For the impatient</a></p></li>
<li><p><a class="reference internal" href="#the-importance-of-scaling-down" id="id8">The importance of scaling down</a></p></li>
<li><p><a class="reference internal" href="#scripts-with-required-arguments" id="id9">Scripts with required arguments</a></p></li>
<li><p><a class="reference internal" href="#scripts-with-default-arguments" id="id10">Scripts with default arguments</a></p></li>
<li><p><a class="reference internal" href="#scripts-with-options-and-smart-options" id="id11">Scripts with options (and smart options)</a></p></li>
<li><p><a class="reference internal" href="#scripts-with-flags" id="id12">Scripts with flags</a></p></li>
<li><p><a class="reference internal" href="#plac-for-python-2-x-users" id="id13">plac for Python 2.X users</a></p></li>
<li><p><a class="reference internal" href="#more-features" id="id14">More features</a></p></li>
<li><p><a class="reference internal" href="#what-to-do-if-an-argument-name-clashes-with-a-python-builtin-keyword" id="id15">What to do if an argument name clashes with a Python builtin/keyword?</a></p></li>
<li><p><a class="reference internal" href="#a-realistic-example" id="id16">A realistic example</a></p></li>
<li><p><a class="reference internal" href="#keyword-arguments" id="id17">Keyword arguments</a></p></li>
<li><p><a class="reference internal" href="#plac-vs-argparse" id="id18">plac vs argparse</a></p></li>
<li><p><a class="reference internal" href="#final-example-a-shelve-interface" id="id19">Final example: a shelve interface</a></p></li>
<li><p><a class="reference internal" href="#plac-vs-the-rest-of-the-world" id="id20">plac vs the rest of the world</a></p></li>
<li><p><a class="reference internal" href="#the-future" id="id21">The future</a></p></li>
<li><p><a class="reference internal" href="#trivia-the-story-behind-the-name" id="id22">Trivia: the story behind the name</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#advanced-usages-of-plac" id="id23">Advanced usages of plac</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction" id="id24">Introduction</a></p></li>
<li><p><a class="reference internal" href="#from-scripts-to-interactive-applications" id="id25">From scripts to interactive applications</a></p></li>
<li><p><a class="reference internal" href="#testing-a-plac-application" id="id26">Testing a plac application</a></p></li>
<li><p><a class="reference internal" href="#plac-easy-tests" id="id27">Plac easy tests</a></p></li>
<li><p><a class="reference internal" href="#plac-batch-scripts" id="id28">Plac batch scripts</a></p></li>
<li><p><a class="reference internal" href="#implementing-subcommands" id="id29">Implementing subcommands</a></p></li>
<li><p><a class="reference internal" href="#plac-interpreter-call" id="id30">plac.Interpreter.call</a></p></li>
<li><p><a class="reference internal" href="#readline-support" id="id31">Readline support</a></p></li>
<li><p><a class="reference internal" href="#the-plac-runner" id="id32">The plac runner</a></p></li>
<li><p><a class="reference internal" href="#a-non-class-based-example" id="id33">A non class-based example</a></p></li>
<li><p><a class="reference internal" href="#writing-your-own-plac-runner" id="id34">Writing your own plac runner</a></p></li>
<li><p><a class="reference internal" href="#long-running-commands" id="id35">Long running commands</a></p></li>
<li><p><a class="reference internal" href="#threaded-commands" id="id36">Threaded commands</a></p></li>
<li><p><a class="reference internal" href="#running-commands-as-external-processes" id="id37">Running commands as external processes</a></p></li>
<li><p><a class="reference internal" href="#managing-the-output-of-concurrent-commands" id="id38">Managing the output of concurrent commands</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#experimental-features" id="id39">Experimental features</a></p>
<ul>
<li><p><a class="reference internal" href="#parallel-computing-with-plac" id="id40">Parallel computing with plac</a></p></li>
<li><p><a class="reference internal" href="#monitor-support" id="id41">Monitor support</a></p></li>
<li><p><a class="reference internal" href="#the-plac-server" id="id42">The plac server</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id43">Summary</a></p></li>
<li><p><a class="reference internal" href="#appendix-custom-annotation-objects" id="id44">Appendix: custom annotation objects</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="for-the-impatient">
<h2><a class="toc-backref" href="#id7">For the impatient</a><a class="headerlink" href="#for-the-impatient" title="Permalink to this headline">¶</a></h2>
<p>Here is how you would write a command-line script with plac, taken from
a real life machine learning script that I found on the net:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plac</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># in Python 2.7</span>
    <span class="n">Path</span> <span class="o">=</span> <span class="nb">str</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">pos</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s2">&quot;Model name&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
<span class="nd">@plac</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;output_dir&#39;</span><span class="p">,</span> <span class="s2">&quot;Optional output directory&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">)</span>
<span class="nd">@plac</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;n_iter&#39;</span><span class="p">,</span> <span class="s2">&quot;Number of training iterations&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="nd">@plac</span><span class="o">.</span><span class="n">flg</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s2">&quot;Enable debug mode&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A script for machine learning&quot;&quot;&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Running the script with <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">example_all.py</span> <span class="pre">-h</span></code> will give you
the following help message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example_all</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">o</span> <span class="o">.</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">n</span> <span class="mi">100</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">d</span><span class="p">]</span> <span class="p">{</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">}</span>

<span class="n">A</span> <span class="n">script</span> <span class="k">for</span> <span class="n">machine</span> <span class="n">learning</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="p">{</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">}</span>               <span class="n">Model</span> <span class="n">name</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">o</span> <span class="o">.</span><span class="p">,</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="nb">dir</span> <span class="o">.</span>  <span class="n">Optional</span> <span class="n">output</span> <span class="n">directory</span>
  <span class="o">-</span><span class="n">n</span> <span class="mi">100</span><span class="p">,</span> <span class="o">--</span><span class="n">n</span><span class="o">-</span><span class="nb">iter</span> <span class="mi">100</span>  <span class="n">Number</span> <span class="n">of</span> <span class="n">training</span> <span class="n">iterations</span>
  <span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="o">--</span><span class="n">debug</span>           <span class="n">Enable</span> <span class="n">debug</span> <span class="n">mode</span>
</pre></div>
</div>
<p>The patient readers will find all the explanations in the sections below.</p>
</div>
<div class="section" id="the-importance-of-scaling-down">
<h2><a class="toc-backref" href="#id8">The importance of scaling down</a><a class="headerlink" href="#the-importance-of-scaling-down" title="Permalink to this headline">¶</a></h2>
<p>There is no want of command-line arguments parsers in the Python
world. The standard library alone contains three different modules:
<a class="reference external" href="http://docs.python.org/library/getopt.html">getopt</a> (from the stone age),
<a class="reference external" href="http://docs.python.org/library/optparse.html">optparse</a> (from Python 2.3) and <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> (from Python 2.7).  All of
them are quite powerful and especially <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> is an industrial
strength solution; unfortunately, all of them feature a non-negligible learning
curve and a certain verbosity. They do not scale down well enough, at
least in my opinion.</p>
<p>It should not be necessary to stress the importance of <a class="reference external" href="https://www.welton.it/articles/scalable_systems.html">scaling down</a>;
nevertheless, a lot of people are obsessed with features and concerned with
the possibility of scaling up, forgetting the equally important
issue of scaling down. This is an old meme in
the computing world: programs should address the common cases simply and
simple things should be kept simple, while at the same time keeping
difficult things possible. <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> adhere as much as possible to this
philosophy and it is designed to handle well the simple cases, while
retaining the ability to handle complex cases by relying on the
underlying power of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>.</p>
<p>Technically <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is just a simple wrapper over <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> which hides
most of its complexity by using a declarative interface: the argument
parser is inferred rather than written down by imperatively.  Still, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is
surprisingly scalable upwards, even without using the underlying
<a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>. I have been using Python for 9 years and in my experience
it is extremely unlikely that you will ever need to go beyond the
features provided by the declarative interface of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>: they should
be more than enough for 99.9% of the use cases.</p>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is targetting especially unsophisticated users,
programmers, sys-admins, scientists and in general people writing
throw-away scripts for themselves, choosing the command-line
interface because it is quick and simple. Such users are not
interested in features, they are interested in a small learning curve:
they just want to be able to write a simple command line tool from a
simple specification, not to build a command-line parser by
hand. Unfortunately, the modules in the standard library forces them
to go the hard way. They are designed to implement power user tools
and they have a non-trivial learning curve. On the contrary, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>
is designed to be simple to use and extremely concise, as the examples
below will show.</p>
</div>
<div class="section" id="scripts-with-required-arguments">
<h2><a class="toc-backref" href="#id9">Scripts with required arguments</a><a class="headerlink" href="#scripts-with-required-arguments" title="Permalink to this headline">¶</a></h2>
<p>Let me start with the simplest possible thing: a script that takes a
single argument and does something to it.  It cannot get simpler
than that, unless you consider the case of a script without command-line
arguments, where there is nothing to parse. Still, it is a use
case <em>extremely common</em>: I need to write scripts like that nearly
every day, I wrote hundreds of them in the last few years and I have
never been happy. Here is a typical example of code I have been
writing by hand for years:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example1.py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">):</span>
    <span class="s2">&quot;Do something with the database&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;usage: python </span><span class="si">%s</span><span class="s1"> dsn&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Unrecognized arguments: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
</pre></div>
</div>
<p>As you see the whole <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> block (nine lines)
is essentially boilerplate that should not exist.  Actually I think
the language should recognize the main function and pass the
command-line arguments automatically; unfortunaly this is unlikely to
happen. I have been writing boilerplate like this in hundreds of
scripts for years, and every time I <em>hate</em> it. The purpose of using a
scripting language is convenience and trivial things should be
trivial. Unfortunately the standard library does not help for this
incredibly common use case. Using <a class="reference external" href="http://docs.python.org/library/getopt.html">getopt</a> and <a class="reference external" href="http://docs.python.org/library/optparse.html">optparse</a> does not help,
since they are intended to manage options and not positional
arguments; the <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> module helps a bit and it is able to reduce
the boilerplate from nine lines to six lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example2.py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">):</span>
    <span class="s2">&quot;Do something on the database&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>
    <span class="c1"># ...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;dsn&#39;</span><span class="p">)</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">main</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">dsn</span><span class="p">)</span>
</pre></div>
</div>
<p>However, it just feels too complex to instantiate a class and to
define a parser by hand for such a trivial task.</p>
<p>The <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> module is designed to manage well such use cases, and it is able
to reduce the original nine lines of boiler plate to two lines. With the
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> module all you need to write is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example3.py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">):</span>
    <span class="s2">&quot;Do something with the database&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>
    <span class="c1"># ...</span>
 
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> module provides for free (actually the work is done by the
underlying <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> module) a nice usage message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python example3.py -h
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example3</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="n">dsn</span>

<span class="n">Do</span> <span class="n">something</span> <span class="k">with</span> <span class="n">the</span> <span class="n">database</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>  <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p>Moreover <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> manages the case of missing arguments and of too many arguments.
This is only the tip of the iceberg: <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is able to do much more than that.</p>
</div>
<div class="section" id="scripts-with-default-arguments">
<h2><a class="toc-backref" href="#id10">Scripts with default arguments</a><a class="headerlink" href="#scripts-with-default-arguments" title="Permalink to this headline">¶</a></h2>
<p>The need to have suitable defaults for command-line scripts is quite
common. For instance I have encountered this use case at work hundreds
of times:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example4.py</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">today</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
    <span class="s2">&quot;Do something on the database&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span> <span class="c1"># manual management before argparse</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;usage: python </span><span class="si">%s</span><span class="s1"> dsn&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Unrecognized arguments: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
    <span class="n">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Here I want to perform a query on a database table, by extracting the
most recent data: it makes sense for <code class="docutils literal notranslate"><span class="pre">today</span></code> to be a default argument.
If there is a most used table (in this example a table called <code class="docutils literal notranslate"><span class="pre">'product'</span></code>)
it also makes sense to make it a default argument. Performing the parsing
of the command-line arguments by hand takes 8 ugly lines of boilerplate
(using <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> would require about the same number of lines).
With <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> the entire <code class="docutils literal notranslate"><span class="pre">__main__</span></code> block reduces to the usual two lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>In other words, six lines of boilerplate have been removed, and we get
the usage message for free:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example5</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="n">dsn</span> <span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="p">[</span><span class="n">today</span><span class="p">]</span>

<span class="n">Do</span> <span class="n">something</span> <span class="n">on</span> <span class="n">the</span> <span class="n">database</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>
  <span class="n">table</span>       <span class="p">[</span><span class="n">product</span><span class="p">]</span>
  <span class="n">today</span>       <span class="p">[</span><span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span><span class="p">]</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>  <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p>Notice that by default <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> prints the string representation
of the default values (with square brackets) in the usage message.
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> manages transparently even the case when you want to pass a
variable number of arguments. Here is an example, a script running
on a database a series of SQL scripts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example7.py</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="o">*</span><span class="n">scripts</span><span class="p">):</span>
    <span class="s2">&quot;Run the given scripts on the database&quot;</span>
    <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;executing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">script</span><span class="p">)</span>
        <span class="c1"># ...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the usage message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example7</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="n">dsn</span> <span class="p">[</span><span class="n">scripts</span> <span class="p">[</span><span class="n">scripts</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">Run</span> <span class="n">the</span> <span class="n">given</span> <span class="n">scripts</span> <span class="n">on</span> <span class="n">the</span> <span class="n">database</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>
  <span class="n">scripts</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>  <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p>The examples here should have made clear that <em>plac is able to figure out
the command-line arguments parser to use from the signature of the main
function</em>. This is the whole idea behind <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>: if the intent is clear,
let’s the machine take care of the details.</p>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is inspired to an old Python Cookbook recipe of mine (<a class="reference external" href="http://code.activestate.com/recipes/278844-parsing-the-command-line/">optionparse</a>), in
the sense that it delivers the programmer from the burden of writing
the parser, but is less of a hack: instead of extracting the parser
from the docstring of the module, it extracts it from the signature of
the <code class="docutils literal notranslate"><span class="pre">main</span></code> function.</p>
<p>The idea comes from the <cite>function annotations</cite> concept, a new
feature of Python 3. An example is worth a thousand words, so here
it is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example7_.py</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">:</span> <span class="s2">&quot;Database dsn&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scripts</span><span class="p">:</span> <span class="s2">&quot;SQL scripts&quot;</span><span class="p">):</span>
    <span class="s2">&quot;Run the given scripts on the database&quot;</span>
    <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;executing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">script</span><span class="p">)</span>
        <span class="c1"># ...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Here the arguments of the <code class="docutils literal notranslate"><span class="pre">main</span></code> function have been annotated with
strings which are intented to be used in the help message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example7_</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="n">dsn</span> <span class="p">[</span><span class="n">scripts</span> <span class="p">[</span><span class="n">scripts</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">Run</span> <span class="n">the</span> <span class="n">given</span> <span class="n">scripts</span> <span class="n">on</span> <span class="n">the</span> <span class="n">database</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>         <span class="n">Database</span> <span class="n">dsn</span>
  <span class="n">scripts</span>     <span class="n">SQL</span> <span class="n">scripts</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>  <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is able to recognize much more complex annotations, as
I will show in the next paragraphs.</p>
</div>
<div class="section" id="scripts-with-options-and-smart-options">
<h2><a class="toc-backref" href="#id11">Scripts with options (and smart options)</a><a class="headerlink" href="#scripts-with-options-and-smart-options" title="Permalink to this headline">¶</a></h2>
<p>It is surprising how few command-line scripts with options I have
written over the years (probably less than a hundred), compared to the
number of scripts with positional arguments I wrote (certainly more
than a thousand of them).  Still, this use case cannot be neglected.
The standard library modules (all of them) are quite verbose when it
comes to specifying the options and frankly I have never used them
directly. Instead, I have always relied on the
<a class="reference external" href="http://code.activestate.com/recipes/278844-parsing-the-command-line/">optionparse</a> recipe, which provides a convenient wrapper over
<a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>. Alternatively, in the simplest cases, I have just
performed the parsing by hand. In <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> the parser is inferred by the
function annotations. Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example8.py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;SQL query&quot;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="n">dsn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;executing </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dsn</span><span class="p">))</span>
        <span class="c1"># ...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Here the argument <code class="docutils literal notranslate"><span class="pre">command</span></code> has been annotated with the tuple
<code class="docutils literal notranslate"><span class="pre">(&quot;SQL</span> <span class="pre">query&quot;,</span> <span class="pre">'option',</span> <span class="pre">'c')</span></code>: the first string is the help string
which will appear in the usage message, the second string tells <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>
that <code class="docutils literal notranslate"><span class="pre">command</span></code> is an option and the third string that there is also
a short form of the option <code class="docutils literal notranslate"><span class="pre">-c</span></code>, the long form being <code class="docutils literal notranslate"><span class="pre">--command</span></code>.
The usage message is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example8</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">c</span> <span class="n">COMMAND</span><span class="p">]</span> <span class="n">dsn</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">c</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="o">--</span><span class="n">command</span> <span class="n">COMMAND</span>
                        <span class="n">SQL</span> <span class="n">query</span>
</pre></div>
</div>
<p>Here are two examples of usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 example8.py -c &quot;select * from table&quot; dsn
executing select * from table on dsn

$ python3 example8.py --command=&quot;select * from table&quot; dsn
executing select * from table on dsn
</pre></div>
</div>
<p>The third argument in the function annotation can be omitted: in such
case it will be assumed to be <code class="docutils literal notranslate"><span class="pre">None</span></code>. The consequence is that
the usual dichotomy between long and short options (GNU-style options)
disappears: we get <em>smart options</em>, which have the single character prefix
of short options and behave like both long and short options, since
they can be abbreviated. Here is an example featuring smart options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example6.py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;SQL query&quot;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">)</span><span class="o">=</span><span class="s1">&#39;select * from table&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;executing </span><span class="si">%r</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dsn</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example6</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">command</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">table</span><span class="p">]</span> <span class="n">dsn</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">command</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">table</span>
                        <span class="n">SQL</span> <span class="n">query</span>
</pre></div>
</div>
<p>The following are all valid invocations ot the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 example6.py -c &quot;select&quot; dsn
executing &#39;select&#39; on dsn
$ python3 example6.py -com &quot;select&quot; dsn
executing &#39;select&#39; on dsn
$ python3 example6.py -command=&quot;select&quot; dsn
executing &#39;select&#39; on dsn
</pre></div>
</div>
<p>Notice that the form <code class="docutils literal notranslate"><span class="pre">-command=SQL</span></code> (with the <code class="docutils literal notranslate"><span class="pre">=</span></code> sign) is recognized
only for the full option, not for its abbreviations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 example6.py -com=&quot;select&quot; dsn
usage: example6.py [-h] [-command COMMAND] dsn
example6.py: error: unrecognized arguments: -com=select
</pre></div>
</div>
<p>If the option is not passed, the variable <code class="docutils literal notranslate"><span class="pre">command</span></code>
will get the value <code class="docutils literal notranslate"><span class="pre">None</span></code>. However, it is possible to specify a non-trivial
default. Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example8_.py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;SQL query&quot;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span><span class="o">=</span><span class="s1">&#39;select * from table&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;executing </span><span class="si">%r</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dsn</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that the default value appears in the help message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example8_</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">c</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">table</span><span class="p">]</span> <span class="n">dsn</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">c</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">table</span><span class="p">,</span> <span class="o">--</span><span class="n">command</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">table</span>
                        <span class="n">SQL</span> <span class="n">query</span>
</pre></div>
</div>
<p>When you run the script and you do not pass the <code class="docutils literal notranslate"><span class="pre">-command</span></code> option, the
default query will be executed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 example8_.py dsn
executing &#39;select * from table&#39; on dsn
</pre></div>
</div>
</div>
<div class="section" id="scripts-with-flags">
<h2><a class="toc-backref" href="#id12">Scripts with flags</a><a class="headerlink" href="#scripts-with-flags" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is able to recognize flags, i.e. boolean options which are
<code class="docutils literal notranslate"><span class="pre">True</span></code> if they are passed to the command line and <code class="docutils literal notranslate"><span class="pre">False</span></code>
if they are absent. Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example9.py</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">verbose</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;prints more info&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">),</span> <span class="n">dsn</span><span class="p">:</span> <span class="s1">&#39;connection string&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;connecting to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dsn</span><span class="p">)</span>
    <span class="c1"># ...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example9</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">v</span><span class="p">]</span> <span class="n">dsn</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">dsn</span>            <span class="n">connection</span> <span class="n">string</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>     <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">--</span><span class="n">verbose</span>  <span class="n">prints</span> <span class="n">more</span> <span class="n">info</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 example9.py -v dsn
connecting to dsn
</pre></div>
</div>
<p>Notice that it is an error trying to specify a default for flags: the
default value for a flag is always <code class="docutils literal notranslate"><span class="pre">False</span></code>. If you feel the need to
implement non-boolean flags, you should use an option with two
choices, as explained in the “more features” section.</p>
<p>For consistency with the way the usage message is printed, I suggest
you to follow the Flag-Option-Required-Default (FORD) convention: in
the <code class="docutils literal notranslate"><span class="pre">main</span></code> function write first the flag arguments, then the option
arguments, then the required arguments and finally the default
arguments. This is just a convention and you are not forced to use it,
except for the default arguments (including the varargs) which must
stay at the end as it is required by the Python syntax.</p>
<p>I also suggests to specify a one-character abbreviation for flags: in
this way you can use the GNU-style composition of flags (i.e. <code class="docutils literal notranslate"><span class="pre">-zxvf</span></code>
is an abbreviation of <code class="docutils literal notranslate"><span class="pre">-z</span> <span class="pre">-x</span> <span class="pre">-v</span> <span class="pre">-f</span></code>). I usually do not provide
the one-character abbreviation for options, since it does not make sense
to compose them.</p>
<p>Starting from <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> 0.9.1 underscores in options and flags are
automatically turned into dashes. This feature was implemented at user
request, to make it possible to use a more traditional naming. For
instance now you can have a <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> flag, whereas before you had
to use <code class="docutils literal notranslate"><span class="pre">--dry_run</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dry_run</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Dry run&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Doing nothing&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Doing something&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is an example of usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3.2 dry_run.py -h
usage: dry_run.py [-h] [-d]

optional arguments:
  -h, --help     show this help message and exit
  -d, --dry-run  Dry run
</pre></div>
</div>
</div>
<div class="section" id="plac-for-python-2-x-users">
<h2><a class="toc-backref" href="#id13">plac for Python 2.X users</a><a class="headerlink" href="#plac-for-python-2-x-users" title="Permalink to this headline">¶</a></h2>
<p>Even if Python 2 has reached its end of life, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>
still provides a way to work with function annotations by means of
decorators. For instance the annotated function declaration</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">:</span> <span class="s2">&quot;Database dsn&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scripts</span><span class="p">:</span> <span class="s2">&quot;SQL scripts&quot;</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>is equivalent to the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
    <span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;Database dsn&quot;</span><span class="p">,</span>
    <span class="n">scripts</span><span class="o">=</span><span class="s2">&quot;SQL scripts&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="o">*</span><span class="n">scripts</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In the rest of this article I will assume that you are using Python 2.X with
X &gt;= 4 and I will use the <code class="docutils literal notranslate"><span class="pre">plac.annotations</span></code> decorator. Notice however
that the core features of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> run even on Python 2.3.</p>
</div>
<div class="section" id="more-features">
<h2><a class="toc-backref" href="#id14">More features</a><a class="headerlink" href="#more-features" title="Permalink to this headline">¶</a></h2>
<p>One of the goals of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is to have a learning curve of <em>minutes</em> for
its core features, compared to the learning curve of <em>hours</em> of
<a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>. In order to reach this goal, I have <em>not</em> sacrificed all
the features of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>. Actually a lot of the <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> power persists
in <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>.  Until now, I have only showed simple annotations, but in
general an annotation is a 6-tuple of the form</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">(help,</span> <span class="pre">kind,</span> <span class="pre">abbrev,</span> <span class="pre">type,</span> <span class="pre">choices,</span> <span class="pre">metavar)</span></code></p>
</div></blockquote>
<p>where <code class="docutils literal notranslate"><span class="pre">help</span></code> is the help message, <code class="docutils literal notranslate"><span class="pre">kind</span></code> is a string in the set {
<code class="docutils literal notranslate"><span class="pre">&quot;flag&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;option&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;positional&quot;</span></code>}, <code class="docutils literal notranslate"><span class="pre">abbrev</span></code> is a
one-character string or <code class="docutils literal notranslate"><span class="pre">None</span></code>, <code class="docutils literal notranslate"><span class="pre">type</span></code> is a callable taking a
string in input,
<code class="docutils literal notranslate"><span class="pre">choices</span></code> is a discrete sequence of values and <code class="docutils literal notranslate"><span class="pre">metavar</span></code> is a string.</p>
<p><code class="docutils literal notranslate"><span class="pre">type</span></code> is used to automagically convert the command line arguments
from the string type to any Python type; by default there is no
conversion and <code class="docutils literal notranslate"><span class="pre">type=None</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">choices</span></code> is used to restrict the number of the valid
options; by default there is no restriction i.e. <code class="docutils literal notranslate"><span class="pre">choices=None</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">metavar</span></code> has two meanings. For a positional argument it is used to
change the argument name in the usage message (and only there). By
default the metavar is <code class="docutils literal notranslate"><span class="pre">None</span></code> and the name in the usage message is
the same as the argument name.  For an option
the <code class="docutils literal notranslate"><span class="pre">metavar</span></code> is used differently in the usage message, which has
now the form <code class="docutils literal notranslate"><span class="pre">[--option-name</span> <span class="pre">METAVAR]</span></code>. If the <code class="docutils literal notranslate"><span class="pre">metavar</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>,
then it is equal to the uppercased name of the argument, unless the
argument has a default: then it is equal to the stringified
form of the default.</p>
<p>Here is an example showing all of the features, including the metavar,
copied from the <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> documentation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example10.py</span>
<span class="kn">import</span> <span class="nn">plac</span>


<span class="c1"># example with full annotations (help, kind, abbrev, type, choices, metavar)</span>
<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
    <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;The name of an operator&quot;</span><span class="p">,</span> <span class="s1">&#39;positional&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span>
              <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">]),</span>
    <span class="n">numbers</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Zero or more numbers&quot;</span><span class="p">,</span> <span class="s1">&#39;positional&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="o">*</span><span class="n">numbers</span><span class="p">):</span>
    <span class="s2">&quot;A script to add and multiply numbers&quot;</span>
    <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
        <span class="n">op</span> <span class="o">=</span> <span class="nb">float</span><span class="o">.</span><span class="fm">__mul__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># operator == &#39;add&#39;</span>
        <span class="n">op</span> <span class="o">=</span> <span class="nb">float</span><span class="o">.</span><span class="fm">__add__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">))</span>
</pre></div>
</div>
<p>If you cannot remember the order of the annotations you can use
the <code class="docutils literal notranslate"><span class="pre">plac.Annotation</span></code> class (there is an example in the next section)
or the alternative decoration syntax introduced in version 1.2:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@plac</span><span class="o">.</span><span class="n">pos</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s2">&quot;The name of an operator&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">])</span>
<span class="nd">@plac</span><span class="o">.</span><span class="n">pos</span><span class="p">(</span><span class="s1">&#39;numbers&#39;</span><span class="p">,</span> <span class="s2">&quot;Zero or more numbers&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="o">*</span><span class="n">numbers</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>which is more compact. There are also a <code class="docutils literal notranslate"><span class="pre">plac.opt</span></code> decorator for options
and <code class="docutils literal notranslate"><span class="pre">plac.flg</span></code> decorator for flags and they can be stacked together at will.</p>
<p>Here is the usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example10</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">{</span><span class="n">add</span><span class="p">,</span><span class="n">mul</span><span class="p">}</span> <span class="p">[</span><span class="n">n</span> <span class="p">[</span><span class="n">n</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">A</span> <span class="n">script</span> <span class="n">to</span> <span class="n">add</span> <span class="ow">and</span> <span class="n">multiply</span> <span class="n">numbers</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="p">{</span><span class="n">add</span><span class="p">,</span><span class="n">mul</span><span class="p">}</span>   <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">an</span> <span class="n">operator</span>
  <span class="n">n</span>           <span class="n">Zero</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">numbers</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>  <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p>Notice that the docstring of the <code class="docutils literal notranslate"><span class="pre">main</span></code> function has been automatically added
to the usage message. Here are a couple of examples of usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python example10.py add 1 2 3 4
10.0
$ python example10.py mul 1 2 3 4
24.0
$ python example10.py ad 1 2 3 4 # a mispelling error
usage: example10.py [-h] {add,mul} [n [n ...]]
example10.py: error: argument operator: invalid choice: &#39;ad&#39; (choose from &#39;add&#39;, &#39;mul&#39;)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">plac.call</span></code> can also be used in doctests like this:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">plac</span><span class="o">,</span> <span class="nn">example10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">example10</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">])</span>
<span class="go">3.0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">plac.call</span></code> works for generators too:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
<span class="gp">... </span>        <span class="k">yield</span> <span class="n">i</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">])</span>
<span class="go">[0, 1, 2]</span>
</pre></div>
</div>
<p>Internally <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> tries to convert the output of the main function
into a list, if possible. If the output is not iterable or it is a
string, it is left unchanged, but if it is iterable it is converted.
In particular, generator objects are exhausted by <code class="docutils literal notranslate"><span class="pre">plac.call</span></code>.</p>
<p>This behavior avoids mistakes like forgetting of applying
<code class="docutils literal notranslate"><span class="pre">list(result)</span></code> to the result of <code class="docutils literal notranslate"><span class="pre">plac.call</span></code>; moreover it makes
errors visible early, and avoids mistakes in code like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
   <span class="c1"># do something</span>
</pre></div>
</div>
<p>Without eagerness, a main function returning a generator object would
not raise any exception until the generator is iterated over.
If you are a fan of lazyness, you can still have it by setting the <code class="docutils literal notranslate"><span class="pre">eager</span></code>
flag to <code class="docutils literal notranslate"><span class="pre">False</span></code>, as in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">main</span></code> returns a generator object this example will print each
line as soon as available, whereas the default behaviour is to print
all the lines together and the end of the computation.</p>
</div>
<div class="section" id="what-to-do-if-an-argument-name-clashes-with-a-python-builtin-keyword">
<h2><a class="toc-backref" href="#id15">What to do if an argument name clashes with a Python builtin/keyword?</a><a class="headerlink" href="#what-to-do-if-an-argument-name-clashes-with-a-python-builtin-keyword" title="Permalink to this headline">¶</a></h2>
<p>Since version 1.3, thanks to a contribution of <a class="reference external" href="https://github.com/ialbert">Istvan Albert</a>, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>
manages such cases easily. The trick is to add one (or more) trailing
underscores to the arguments that would clash; <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> will automatically
strip the underscores:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example13.py</span>
<span class="kn">import</span> <span class="nn">plac</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">flg</span><span class="p">(</span><span class="s1">&#39;list_&#39;</span><span class="p">)</span>  <span class="c1"># avoid clash with builtin</span>
<span class="nd">@plac</span><span class="o">.</span><span class="n">flg</span><span class="p">(</span><span class="s1">&#39;yield_&#39;</span><span class="p">)</span>  <span class="c1"># avoid clash with keyword</span>
<span class="nd">@plac</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;sys_&#39;</span><span class="p">)</span>  <span class="c1"># avoid clash with a very common name</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">list_</span><span class="p">,</span> <span class="n">yield_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sys_</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">list_</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">yield_</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sys_</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>The usage message will be as you would expect:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python doc/example13.py -h
usage: example13.py [-h] [-l] [-y] [-s 100]

optional arguments:
  -h, --help         show this help message and exit
  -l, --list
  -y, --yield        [False]
  -s 100, --sys 100  [100]
</pre></div>
</div>
</div>
<div class="section" id="a-realistic-example">
<h2><a class="toc-backref" href="#id16">A realistic example</a><a class="headerlink" href="#a-realistic-example" title="Permalink to this headline">¶</a></h2>
<p>Here is a more realistic script using most of the features of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> to
run SQL queries on a database by relying on <a class="reference external" href="http://www.sqlalchemy.org/">SQLAlchemy</a>. Notice the usage
of the <code class="docutils literal notranslate"><span class="pre">type</span></code> feature to automagically convert a SQLAlchemy connection
string into a <a class="reference external" href="http://www.sqlalchemy.org/docs/reference/ext/sqlsoup.html">SqlSoup</a> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dbcli.py</span>
<span class="kn">import</span> <span class="nn">plac</span>
<span class="kn">from</span> <span class="nn">sqlsoup</span> <span class="kn">import</span> <span class="n">SQLSoup</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
    <span class="n">db</span><span class="o">=</span><span class="n">plac</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="s2">&quot;Connection string&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SQLSoup</span><span class="p">),</span>
    <span class="n">header</span><span class="o">=</span><span class="n">plac</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="s2">&quot;Header&quot;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">),</span>
    <span class="n">sqlcmd</span><span class="o">=</span><span class="n">plac</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="s2">&quot;SQL command&quot;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;SQL&quot;</span><span class="p">),</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="n">plac</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="s2">&quot;Column separator&quot;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">),</span>
    <span class="n">scripts</span><span class="o">=</span><span class="n">plac</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span><span class="s2">&quot;SQL scripts&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">sqlcmd</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scripts</span><span class="p">):</span>
    <span class="s2">&quot;A script to run queries and SQL scripts on a database&quot;</span>
    <span class="k">yield</span> <span class="s1">&#39;Working on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">db</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">url</span>

    <span class="k">if</span> <span class="n">sqlcmd</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlcmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>  <span class="c1"># print the header</span>
            <span class="k">yield</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>  <span class="c1"># print the rows</span>
            <span class="k">yield</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">script</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">yield</span> <span class="s1">&#39;executed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">script</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>You can see the <em>yield-is-print</em> pattern here: instead of using
<code class="docutils literal notranslate"><span class="pre">print</span></code> in the main function, I use <code class="docutils literal notranslate"><span class="pre">yield</span></code>, and I perform the
print in the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> block. The advantage of the pattern is that
tests invoking <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> and checking the result become trivial:
had I performed the printing in the main function, the test would have
involved an ugly hack like redirecting <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> to a
<code class="docutils literal notranslate"><span class="pre">StringIO</span></code> object.</p>
<p>Here is the usage message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">dbcli</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">H</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">c</span> <span class="n">SQL</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">d</span> <span class="o">|</span><span class="p">]</span> <span class="n">db</span> <span class="p">[</span><span class="n">scripts</span> <span class="p">[</span><span class="n">scripts</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">A</span> <span class="n">script</span> <span class="n">to</span> <span class="n">run</span> <span class="n">queries</span> <span class="ow">and</span> <span class="n">SQL</span> <span class="n">scripts</span> <span class="n">on</span> <span class="n">a</span> <span class="n">database</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">db</span>                    <span class="n">Connection</span> <span class="n">string</span>
  <span class="n">scripts</span>               <span class="n">SQL</span> <span class="n">scripts</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="o">--</span><span class="n">header</span>          <span class="n">Header</span>
  <span class="o">-</span><span class="n">c</span> <span class="n">SQL</span><span class="p">,</span> <span class="o">--</span><span class="n">sqlcmd</span> <span class="n">SQL</span>  <span class="n">SQL</span> <span class="n">command</span>
  <span class="o">-</span><span class="n">d</span> <span class="o">|</span><span class="p">,</span> <span class="o">--</span><span class="n">delimiter</span> <span class="o">|</span>   <span class="n">Column</span> <span class="n">separator</span>
</pre></div>
</div>
<p>You can check for yourself that the script works.</p>
</div>
<div class="section" id="keyword-arguments">
<h2><a class="toc-backref" href="#id17">Keyword arguments</a><a class="headerlink" href="#keyword-arguments" title="Permalink to this headline">¶</a></h2>
<p>Starting from release 0.4, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> supports keyword arguments.  In
practice that means that if your main function has keyword arguments,
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> treats specially arguments of the form <code class="docutils literal notranslate"><span class="pre">&quot;name=value&quot;</span></code> in the
command line.  Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example12.py</span>
<span class="kn">import</span> <span class="nn">plac</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
   <span class="n">opt</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;some option&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">),</span>
   <span class="n">args</span><span class="o">=</span><span class="s1">&#39;default arguments&#39;</span><span class="p">,</span>
   <span class="n">kw</span><span class="o">=</span><span class="s1">&#39;keyword arguments&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>
       <span class="k">yield</span> <span class="s1">&#39;opt=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">opt</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
       <span class="k">yield</span> <span class="s1">&#39;args=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
       <span class="k">yield</span> <span class="s1">&#39;kw=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kw</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">):</span>
       <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the generated usage message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example12</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">opt</span> <span class="n">OPT</span><span class="p">]</span> <span class="p">[</span><span class="n">args</span> <span class="p">[</span><span class="n">args</span> <span class="o">...</span><span class="p">]]</span> <span class="p">[</span><span class="n">kw</span> <span class="p">[</span><span class="n">kw</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">args</span>        <span class="n">default</span> <span class="n">arguments</span>
  <span class="n">kw</span>          <span class="n">keyword</span> <span class="n">arguments</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>  <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">opt</span> <span class="n">OPT</span>    <span class="n">some</span> <span class="n">option</span>
</pre></div>
</div>
<p>Here is how you call the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python example12.py -o X a1 a2 name=value
opt=X
args=(&#39;a1&#39;, &#39;a2&#39;)
kw={&#39;name&#39;: &#39;value&#39;}
</pre></div>
</div>
<p>When using keyword arguments, one must be careful to use names which
are not alreay taken; for instance in this examples the name <code class="docutils literal notranslate"><span class="pre">opt</span></code>
is taken:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python example12.py 1 2 kw1=1 kw2=2 opt=0
usage: example12.py [-h] [-o OPT] [args [args ...]] [kw [kw ...]]
example12.py: error: colliding keyword arguments: opt
</pre></div>
</div>
<p>The names taken are the names of the flags, of the options, and of the
positional arguments, excepted varargs and keywords. This limitation
is a consequence of the way the argument names are managed in function calls
by the Python language.</p>
</div>
<div class="section" id="plac-vs-argparse">
<h2><a class="toc-backref" href="#id18">plac vs argparse</a><a class="headerlink" href="#plac-vs-argparse" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is opinionated and by design it does not try to make available
all of the features of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> in an easy way.  In particular you
should be aware of the following limitations/differences (the
following assumes knowledge of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>):</p>
<ul class="simple">
<li><p>plac does not support the destination concept: the destination
coincides with the name of the argument, always. This restriction
has some drawbacks. For instance, suppose you want to define a long
option called <code class="docutils literal notranslate"><span class="pre">--yield</span></code>. In this case the destination would be <code class="docutils literal notranslate"><span class="pre">yield</span></code>,
which is a Python keyword, and since you cannot introduce an
argument with that name in a function definition, it is impossible
to implement it. Your choices are to change the name of the long
option, or to use <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> with a suitable destination.</p></li>
<li><p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> does not support “required options”. As the <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>
documentation puts it: <em>Required options are generally considered bad
form - normal users expect options to be optional. You should avoid
the use of required options whenever possible.</em> Notice that since
<a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> supports them, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> can manage them too, but not directly.</p></li>
<li><p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> supports only regular boolean flags. <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> has the ability to
define generalized two-value flags with values different from <code class="docutils literal notranslate"><span class="pre">True</span></code>
and <code class="docutils literal notranslate"><span class="pre">False</span></code>. An earlier version of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> had this feature too, but
since you can use options with two choices instead, and in any case
the conversion from <code class="docutils literal notranslate"><span class="pre">{True,</span> <span class="pre">False}</span></code> to any couple of values
can be trivially implemented with a ternary operator
(<code class="docutils literal notranslate"><span class="pre">value1</span> <span class="pre">if</span> <span class="pre">flag</span> <span class="pre">else</span> <span class="pre">value2</span></code>), I have removed it (KISS rules!).</p></li>
<li><p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> does not support <code class="docutils literal notranslate"><span class="pre">nargs</span></code> options directly (it uses them internally,
though, to implement flag recognition). The reason it that all the use
cases of interest to me are covered by <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> and I did not feel the need
to increase the learning curve by adding direct support for <code class="docutils literal notranslate"><span class="pre">nargs</span></code>.</p></li>
<li><p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> does support subparsers, but you must read the section
<a class="reference internal" href="plac_adv.html#implementing-subcommands"><span class="std std-ref">Implementing subcommands</span></a> to see how it works.</p></li>
<li><p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> does not support actions directly. This also looks like a feature too
advanced for the goals of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>. Notice, however, that the ability to define
your own annotation objects (again, see the section
<a href="#id1"><span class="problematic" id="id2">:ref:`Implementing subcommand`_</span></a>) may mitigate the need for custom actions.</p></li>
</ul>
<p>On the plus side, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> can leverage directly on a number of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> features.</p>
<p>For instance, you can use <a class="reference external" href="http://argparse.googlecode.com/svn/tags/r11/doc/other-utilities.html?highlight=filetype#FileType">argparse.FileType</a> directly. Moreover,
it is possible to pass options to the underlying
<code class="docutils literal notranslate"><span class="pre">argparse.ArgumentParser</span></code> object (currently it accepts the default
arguments <code class="docutils literal notranslate"><span class="pre">description</span></code>, <code class="docutils literal notranslate"><span class="pre">epilog</span></code>, <code class="docutils literal notranslate"><span class="pre">prog</span></code>, <code class="docutils literal notranslate"><span class="pre">usage</span></code>,
<code class="docutils literal notranslate"><span class="pre">add_help</span></code>, <code class="docutils literal notranslate"><span class="pre">argument_default</span></code>, <code class="docutils literal notranslate"><span class="pre">parents</span></code>, <code class="docutils literal notranslate"><span class="pre">prefix_chars</span></code>,
<code class="docutils literal notranslate"><span class="pre">fromfile_prefix_chars</span></code>, <code class="docutils literal notranslate"><span class="pre">conflict_handler</span></code>, <code class="docutils literal notranslate"><span class="pre">formatter_class</span></code>).
It is enough to set such attributes on the <code class="docutils literal notranslate"><span class="pre">main</span></code> function.  For
instance writing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">main</span><span class="o">.</span><span class="n">add_help</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>disables the recognition of the help flag <code class="docutils literal notranslate"><span class="pre">-h,</span> <span class="pre">--help</span></code>. This
mechanism does not look particularly elegant, but it works well
enough.  I assume that the typical user of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> will be happy with
the defaults and would not want to change them; still it is possible
if she wants to.</p>
<p>For instance, by setting the <code class="docutils literal notranslate"><span class="pre">description</span></code> attribute, it is possible
to add a comment to the usage message (by default the docstring of the
<code class="docutils literal notranslate"><span class="pre">main</span></code> function is used as description).</p>
<p>It is also possible to change the option prefix; for
instance if your script must run under Windows and you want to use “/”
as option prefix you can add the line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main</span><span class="o">.</span><span class="n">prefix_chars</span><span class="o">=</span><span class="s1">&#39;/-&#39;</span>
</pre></div>
</div>
<p>The first prefix char (<code class="docutils literal notranslate"><span class="pre">/</span></code>) is used
as the default for the recognition of options and flags;
the second prefix char (<code class="docutils literal notranslate"><span class="pre">-</span></code>) is kept to keep the <code class="docutils literal notranslate"><span class="pre">-h/--help</span></code> option
working: however you can disable it and reimplement it, if you like.</p>
<p>It is possible to access directly the underlying <a class="reference external" href="http://argparse.googlecode.com/svn/tags/r11/doc/ArgumentParser.html">ArgumentParser</a> object, by
invoking the <code class="docutils literal notranslate"><span class="pre">plac.parser_from</span></code> utility function:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">plac</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">plac</span><span class="o">.</span><span class="n">parser_from</span><span class="p">(</span><span class="n">main</span><span class="p">))</span> 
<span class="go">ArgumentParser(prog=...)</span>
</pre></div>
</div>
<p>Internally <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> uses <code class="docutils literal notranslate"><span class="pre">plac.parser_from</span></code>. Notice that when
<code class="docutils literal notranslate"><span class="pre">plac.call(func)</span></code> is invoked multiple time, the parser is re-used
and not rebuilt from scratch again.</p>
<p>I use <code class="docutils literal notranslate"><span class="pre">plac.parser_from</span></code> in the unit tests of the module, but regular
users should not need to use it, unless they want to access <em>all</em>
of the features of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> directly without calling the main function.</p>
<p>Interested readers should read the documentation of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> to
understand the meaning of the other options. If there is a set of
options that you use very often, you may consider writing a decorator
adding such options to the <code class="docutils literal notranslate"><span class="pre">main</span></code> function for you. For simplicity,
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> does not perform any magic.</p>
</div>
<div class="section" id="final-example-a-shelve-interface">
<h2><a class="toc-backref" href="#id19">Final example: a shelve interface</a><a class="headerlink" href="#final-example-a-shelve-interface" title="Permalink to this headline">¶</a></h2>
<p>Here is a nontrivial example showing off many <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> feature, including
keyword arguments recognition.
The use case is the following: suppose we have stored the
configuration parameters of a given application into a Python shelve
and we need a command-line tool to edit the shelve.
A possible implementation using <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> could be the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ishelve.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">plac</span>

<span class="n">DEFAULT_SHELVE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/conf.shelve&#39;</span><span class="p">)</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;show help&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">),</span>
    <span class="n">showall</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;show all parameters in the shelve&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">),</span>
    <span class="n">clear</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;clear the shelve&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">),</span>
    <span class="n">delete</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;delete an element&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">),</span>
    <span class="n">filename</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;filename of the shelve&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">),</span>
    <span class="n">params</span><span class="o">=</span><span class="s1">&#39;names of the parameters in the shelve&#39;</span><span class="p">,</span>
    <span class="n">setters</span><span class="o">=</span><span class="s1">&#39;setters param=value&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">showall</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">DEFAULT_SHELVE</span><span class="p">,</span>
         <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">setters</span><span class="p">):</span>
    <span class="s2">&quot;A simple interface to a shelve. Use .help to see the available commands.&quot;</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">help</span><span class="p">,</span> <span class="n">showall</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">setters</span><span class="p">]):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;no arguments passed, use .help to see the &#39;</span>
                   <span class="s1">&#39;available commands&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">help</span><span class="p">:</span>  <span class="c1"># custom help</span>
            <span class="k">yield</span> <span class="s1">&#39;Commands: .help, .showall, .clear, .delete&#39;</span>
            <span class="k">yield</span> <span class="s1">&#39;&lt;param&gt; ...&#39;</span>
            <span class="k">yield</span> <span class="s1">&#39;&lt;param=value&gt; ...&#39;</span>
        <span class="k">elif</span> <span class="n">showall</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sh</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clear</span><span class="p">:</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">yield</span> <span class="s1">&#39;cleared the shelve&#39;</span>
        <span class="k">elif</span> <span class="n">delete</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">sh</span><span class="p">[</span><span class="n">delete</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: not found&#39;</span> <span class="o">%</span> <span class="n">delete</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;deleted </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">delete</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">sh</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: not found&#39;</span> <span class="o">%</span> <span class="n">param</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">setters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sh</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">yield</span> <span class="s1">&#39;setting </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">main</span><span class="o">.</span><span class="n">add_help</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># there is a custom help, remove the default one</span>
<span class="n">main</span><span class="o">.</span><span class="n">prefix_chars</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>  <span class="c1"># use dot-prefixed commands</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>A few notes are in order:</p>
<ol class="arabic simple">
<li><p>I have disabled the ordinary help provided by <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> and I have
implemented a custom help command.</p></li>
<li><p>I have changed the prefix character used to recognize the options
to a dot.</p></li>
<li><p>Keyword arguments recognition (in the <code class="docutils literal notranslate"><span class="pre">**setters</span></code>) is used to make it
possible to store a value in the shelve with the syntax
<code class="docutils literal notranslate"><span class="pre">param_name=param_value</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*params</span></code> are used to retrieve parameters from the shelve and some
error checking is performed in the case of missing parameters</p></li>
<li><p>A command to clear the shelve is implemented as a flag (<code class="docutils literal notranslate"><span class="pre">.clear</span></code>).</p></li>
<li><p>A command to delete a given parameter is implemented as an option
(<code class="docutils literal notranslate"><span class="pre">.delete</span></code>).</p></li>
<li><p>There is an option with default (<code class="docutils literal notranslate"><span class="pre">.filename=conf.shelve</span></code>) to set
the filename of the shelve.</p></li>
<li><p>All things considered, the code looks like a poor man’s object oriented
interface implemented with a chain of elifs instead of methods. Of course,
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> can do better than that, but let me start from a low-level approach
first.</p></li>
</ol>
<p>If you run <code class="docutils literal notranslate"><span class="pre">ishelve.py</span></code> without arguments you get the following
message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python ishelve.py
no arguments passed, use .help to see the available commands
</pre></div>
</div>
<p>If you run <code class="docutils literal notranslate"><span class="pre">ishelve.py</span></code> with the option <code class="docutils literal notranslate"><span class="pre">.h</span></code> (or any abbreviation
of <code class="docutils literal notranslate"><span class="pre">.help</span></code>) you get:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python ishelve.py .h
Commands: .help, .showall, .clear, .delete
&lt;param&gt; ...
&lt;param=value&gt; ...
</pre></div>
</div>
<p>You can check by hand that the tool works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python ishelve.py .clear # start from an empty shelve
cleared the shelve
$ python ishelve.py a=1 b=2
setting a=1
setting b=2
$ python ishelve.py .showall
b=2
a=1
$ python ishelve.py .del b # abbreviation for .delete
deleted b
$ python ishelve.py a
1
$ python ishelve.py b
b: not found
$ python ishelve.py .cler # mispelled command
usage: ishelve.py [.help] [.showall] [.clear] [.delete DELETE]
                  [.filename /home/micheles/conf.shelve]
                  [params [params ...]] [setters [setters ...]]
ishelve.py: error: unrecognized arguments: .cler
</pre></div>
</div>
</div>
<div class="section" id="plac-vs-the-rest-of-the-world">
<h2><a class="toc-backref" href="#id20">plac vs the rest of the world</a><a class="headerlink" href="#plac-vs-the-rest-of-the-world" title="Permalink to this headline">¶</a></h2>
<p>Originally <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> boasted about being “the easiest command-line
arguments parser in the world”. Since then, people started pointing
out to me various projects which are based on the same idea
(extracting the parser from the main function signature) and are
arguably even easier than <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://pypi.python.org/pypi/opterator">opterator</a> by Dusty Phillips</p></li>
<li><p><a class="reference external" href="http://pypi.python.org/pypi/CLIArgs">CLIArgs</a> by Pavel Panchekha</p></li>
<li><p><a class="reference external" href="http://pypi.python.org/pypi/commandline">commandline</a> by David Laban</p></li>
</ul>
<p>Luckily for me none of such projects had the idea of using
function annotations and <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>; as a consequence, they are
no match for the capabilities of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>.</p>
<p>Of course, there are tons of other libraries to parse the command
line. For instance <a class="reference external" href="http://pypi.python.org/pypi/Clap">Clap</a> by Matthew Frazier which appeared on PyPI
just the day before <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>; <a class="reference external" href="http://pypi.python.org/pypi/Clap">Clap</a> is fine but it is certainly not
easier than <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>.</p>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> can also be used as a replacement of the <a class="reference external" href="http://docs.python.org/library/cmd.html">cmd</a> module in the standard
library and as such it shares many features with the module <a class="reference external" href="http://packages.python.org/cmd2/">cmd2</a> by
Catherine Devlin. However, this is completely coincidental, since I became
aware of the <a class="reference external" href="http://packages.python.org/cmd2/">cmd2</a> module only after writing <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>.</p>
<p>Command-line argument parsers keep coming out; between the newcomers I
will notice <a class="reference external" href="https://github.com/pulp/marrow.script">marrow.script</a> by Alice Bevan-McGregor, which is quite
similar to <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> in spirit, but does not rely on <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> at all.
<a class="reference external" href="http://packages.python.org/argh">Argh</a> by Andrey Mikhaylenko is also worth mentioning: it is based
on <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>, it came after <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> and I must give credit to the author
for the choice of the name, much funnier than plac!</p>
</div>
<div class="section" id="the-future">
<h2><a class="toc-backref" href="#id21">The future</a><a class="headerlink" href="#the-future" title="Permalink to this headline">¶</a></h2>
<p>Currently the core of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is around 200 lines of code, not counting blanks,
comments and docstrings. I do not plan to extend the core much in the
future. The idea is to keep the module short: it is and it should
remain a little wrapper over <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>. Actually I have thought about
contributing the core back to <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> if <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> becomes successful
and gains a reasonable number of users. For the moment it should be
considered in a frozen status.</p>
<p>Notice that even if <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> has been designed to be simple to use for
simple stuff, its power should not be underestimated; it is actually a
quite advanced tool with a domain of applicability which far exceeds
the realm of command-line arguments parsers.</p>
<p>Version 0.5 of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> doubled the code base and the documentation: it is
based on the idea of using <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> to implement command-line interpreters,
i.e. something akin to the <code class="docutils literal notranslate"><span class="pre">cmd</span></code> module in the standard library, only better.
The new features are implemented in a separated module (<code class="docutils literal notranslate"><span class="pre">plac_ext.py</span></code>), since
they require Python 2.5 to work, whereas <code class="docutils literal notranslate"><span class="pre">plac_core.py</span></code> only requires
Python 2.3.</p>
</div>
<div class="section" id="trivia-the-story-behind-the-name">
<h2><a class="toc-backref" href="#id22">Trivia: the story behind the name</a><a class="headerlink" href="#trivia-the-story-behind-the-name" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> project started very humbly: I just wanted to make
my old <a class="reference external" href="http://code.activestate.com/recipes/278844-parsing-the-command-line/">optionparse</a> recipe easy_installable, and to publish it on PyPI.
The original name of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> was optionparser and the idea behind it was
to build an <a class="reference external" href="http://docs.python.org/library/optparse.html?highlight=optionparser#optparse.OptionParser">OptionParser</a> object from the docstring of the module.
However, before doing that, I decided to check out the <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> module,
since I knew it was going into Python 2.7 and Python 2.7 was coming out.
Soon enough I realized two things:</p>
<ol class="arabic simple">
<li><p>the single greatest idea of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> was unifying the positional arguments
and the options in a single namespace object;</p></li>
<li><p>parsing the docstring was so old-fashioned, considering the existence
of functions annotations in Python 3.</p></li>
</ol>
<p>Putting together these two observations with the original idea of inferring the
parser I decided to build an <a class="reference external" href="http://argparse.googlecode.com/svn/tags/r11/doc/ArgumentParser.html">ArgumentParser</a> object from function
annotations. The <code class="docutils literal notranslate"><span class="pre">optionparser</span></code> name was ruled out, since I was
now using <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>; a name like <code class="docutils literal notranslate"><span class="pre">argparse_plus</span></code> was also ruled out,
since the typical usage was completely different from the <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> usage.</p>
<p>I made a research on PyPI and the name <em>clap</em> (Command Line Arguments Parser)
was not taken, so I renamed everything to clap. After two days
a <a class="reference external" href="http://pypi.python.org/pypi/Clap">Clap</a> module appeared on PyPI &lt;expletives deleted&gt;!</p>
<p>Having little imagination, I decided to rename everything again to plac,
an anagram of clap: since it is a non-existing English name, I hope nobody
will steal it from me!</p>
<p>That concludes the section about the basic usage of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>. You are now ready to
read about the advanced usage.</p>
</div>
</div>
<div class="section" id="advanced-usages-of-plac">
<h1><a class="toc-backref" href="#id23">Advanced usages of plac</a><a class="headerlink" href="#advanced-usages-of-plac" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id24">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>One of the design goals of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is to make it dead easy to write a
scriptable and testable interface for an application.  You can use
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> whenever you have an API with strings in input and strings in
output, and that includes a <em>huge</em> domain of applications.</p>
<p>A string-oriented interface is a scriptable interface by
construction. That means that you can define a command language for
your application and that it is possible to write scripts which are
interpretable by <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> and can be run as batch scripts.</p>
<p>Actually, at the most general level, you can see <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> as a generic tool to
write domain specific languages (DSL). With <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> you
can test your application interactively as well as with batch
scripts, and even with the analogous of Python doctests for your
defined language.</p>
<p>You can easily replace the <code class="docutils literal notranslate"><span class="pre">cmd</span></code> module of the standard library and
you could easily write an application like <a class="reference external" href="http://twill.idyll.org/">twill</a> with <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>. Or you
could use it to script your building procedure. <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> also supports
parallel execution of multiple commands and can be used as
task manager. It is also quite easy to build a GUI
or a Web application on top of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>. When speaking of things
you can do with <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>, your imagination is the only limit!</p>
</div>
<div class="section" id="from-scripts-to-interactive-applications">
<h2><a class="toc-backref" href="#id25">From scripts to interactive applications</a><a class="headerlink" href="#from-scripts-to-interactive-applications" title="Permalink to this headline">¶</a></h2>
<p>Command-line scripts have many advantages, but they are no substitute
for interactive applications.</p>
<p>In particular, if you have a script with a large startup time which must be run
multiple times, it is best to turn it into an interactive application,
so that the startup is performed only once.  <code class="docutils literal notranslate"><span class="pre">plac</span></code> provides an
<code class="docutils literal notranslate"><span class="pre">Interpreter</span></code> class just for this purpose.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Interpreter</span></code> class wraps the main function of a script and
provides an <code class="docutils literal notranslate"><span class="pre">.interact</span></code> method to start an interactive interpreter
reading commands from the console.</p>
<p>For instance, you can define an interactive interpreter on top of the
<code class="docutils literal notranslate"><span class="pre">ishelve</span></code> script introded before as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># shelve_interpreter.py</span>
<span class="kn">import</span> <span class="nn">plac</span><span class="o">,</span> <span class="nn">ishelve</span>

<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
    <span class="n">interactive</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;start interactive interface&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">),</span>
    <span class="n">subcommands</span><span class="o">=</span><span class="s1">&#39;the commands of the underlying ishelve interpreter&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">interactive</span><span class="p">,</span> <span class="o">*</span><span class="n">subcommands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This script works both interactively and non-interactively.</span>
<span class="sd">    Use .help to see the internal commands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
        <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">subcommands</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>A trick has been used here: the ishelve command-line interface has been
hidden inside an external interface. They are distinct: for instance
the external interface recognizes the <code class="docutils literal notranslate"><span class="pre">-h/--help</span></code> flag whereas the
internal interface only recognizes the <code class="docutils literal notranslate"><span class="pre">.help</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python shelve_interpreter.py -h
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">shelve_interpreter</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">interactive</span><span class="p">]</span>
                             <span class="p">[</span><span class="n">subcommands</span> <span class="p">[</span><span class="n">subcommands</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">This</span> <span class="n">script</span> <span class="n">works</span> <span class="n">both</span> <span class="n">interactively</span> <span class="ow">and</span> <span class="n">non</span><span class="o">-</span><span class="n">interactively</span><span class="o">.</span>
<span class="n">Use</span> <span class="o">.</span><span class="n">help</span> <span class="n">to</span> <span class="n">see</span> <span class="n">the</span> <span class="n">internal</span> <span class="n">commands</span><span class="o">.</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">subcommands</span>   <span class="n">the</span> <span class="n">commands</span> <span class="n">of</span> <span class="n">the</span> <span class="n">underlying</span> <span class="n">ishelve</span> <span class="n">interpreter</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>    <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">interactive</span>  <span class="n">start</span> <span class="n">interactive</span> <span class="n">interface</span>
</pre></div>
</div>
<p>Thanks to this ingenuous trick, the script can be run both interactively
and non-interactively:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python shelve_interpreter.py .clear # non-interactive use
cleared the shelve
</pre></div>
</div>
<p>Here is an usage session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python shelve_interpreter.py -i # interactive use
A simple interface to a shelve. Use .help to see the available commands.
i&gt; .help
Commands: .help, .showall, .clear, .delete
&lt;param&gt; ...
&lt;param=value&gt; ...
i&gt; a=1
setting a=1
i&gt; a
1
i&gt; b=2
setting b=2
i&gt; a b
1
2
i&gt; .del a
deleted a
i&gt; a
a: not found
i&gt; .show
b=2
i&gt; [CTRL-D]
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.interact</span></code> method
reads commands from the console and send them to the
underlying interpreter, until the user send a CTRL-D
command (CTRL-Z in Windows). There is a default
argument <code class="docutils literal notranslate"><span class="pre">prompt='i&gt;</span> <span class="pre">'</span></code> which
can be used to change the prompt. The text displayed at the beginning
of the interactive session is the docstring of the main function.
<code class="docutils literal notranslate"><span class="pre">plac</span></code> also understands command abbreviations: in this example
<code class="docutils literal notranslate"><span class="pre">del</span></code> is an abbreviation for <code class="docutils literal notranslate"><span class="pre">delete</span></code>. In case of ambiguous
abbreviations <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> raises a <code class="docutils literal notranslate"><span class="pre">NameError</span></code>.</p>
<p>Finally I must notice that <code class="docutils literal notranslate"><span class="pre">plac.Interpreter</span></code> is available only if you
are using a recent version of Python (&gt;= 2.5), because it is a context
manager object which uses extended generators internally.</p>
</div>
<div class="section" id="testing-a-plac-application">
<h2><a class="toc-backref" href="#id26">Testing a plac application</a><a class="headerlink" href="#testing-a-plac-application" title="Permalink to this headline">¶</a></h2>
<p>You can conveniently test your application in interactive mode.
However manual testing is a poor substitute for automatic testing.</p>
<p>In principle, one could write automatic tests for the
<code class="docutils literal notranslate"><span class="pre">ishelve</span></code> application by using <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># test_ishelve.py</span>
<span class="kn">import</span> <span class="nn">plac</span>
<span class="kn">import</span> <span class="nn">ishelve</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.clear&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;cleared the shelve&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;a=1&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;setting a=1&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.delete=a&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;deleted a&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;a: not found&#39;</span><span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p>However, using <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> is not especially nice. The big
issue is that <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> responds to invalid input by printing an
error message on stderr and by raising a <code class="docutils literal notranslate"><span class="pre">SystemExit</span></code>: this is
certainly not a nice thing to do in a test.</p>
<p>As a consequence of this behavior it is impossible to test for invalid
commands, unless you wrap the <code class="docutils literal notranslate"><span class="pre">SystemExit</span></code> exception by
hand each time (and possibly you do something with the error message in
stderr too). Luckily, <code class="docutils literal notranslate"><span class="pre">plac</span></code> offers a better testing support through
the <code class="docutils literal notranslate"><span class="pre">check</span></code> method of <code class="docutils literal notranslate"><span class="pre">Interpreter</span></code> objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># test_ishelve_more.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">import</span> <span class="nn">ishelve</span>
<span class="kn">import</span> <span class="nn">plac</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">ishelve</span><span class="o">.</span><span class="n">main</span><span class="p">)</span> <span class="k">as</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">i</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;.clear&#39;</span><span class="p">,</span> <span class="s1">&#39;cleared the shelve&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;a=1&#39;</span><span class="p">,</span> <span class="s1">&#39;setting a=1&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;.delete=a&#39;</span><span class="p">,</span> <span class="s1">&#39;deleted a&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a: not found&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">.check(given_input,</span> <span class="pre">expected_output)</span></code> works on strings
and raises an <code class="docutils literal notranslate"><span class="pre">AssertionError</span></code> if the output produced by the
interpreter is different from the expected output for the given input.
Notice that <code class="docutils literal notranslate"><span class="pre">AssertionError</span></code> is catched by tools like <code class="docutils literal notranslate"><span class="pre">pytest</span></code> and
<code class="docutils literal notranslate"><span class="pre">nosetests</span></code> and actually <code class="docutils literal notranslate"><span class="pre">plac</span></code> tests are intended to be run with
such tools.</p>
<p>Interpreters offer a minor syntactic advantage with respect to calling
<code class="docutils literal notranslate"><span class="pre">plac.call</span></code> directly, but they offer a <em>major</em> semantic advantage when things
go wrong (read exceptions): an <code class="docutils literal notranslate"><span class="pre">Interpreter</span></code> object internally invokes
something like <code class="docutils literal notranslate"><span class="pre">plac.call</span></code>, but it wraps all exceptions, so that <code class="docutils literal notranslate"><span class="pre">i.check</span></code>
is guaranteed not to raise any exception except <code class="docutils literal notranslate"><span class="pre">AssertionError</span></code>.</p>
<p>Even the <code class="docutils literal notranslate"><span class="pre">SystemExit</span></code> exception is captured and you can write your test as</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">i.check('-cler',</span> <span class="pre">'SystemExit:</span> <span class="pre">unrecognized</span> <span class="pre">arguments:</span> <span class="pre">-cler')</span></code></p>
</div></blockquote>
<p>without risk of exiting from the Python interpreter.</p>
<p>There is a second advantage of interpreters: if the main function
contains some initialization code and finalization code (<code class="docutils literal notranslate"><span class="pre">__enter__</span></code>
and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> functions) they will be run at the beginning and at
the end of the interpreter loop, whereas <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> ignores
the initialization/finalization code.</p>
</div>
<div class="section" id="plac-easy-tests">
<h2><a class="toc-backref" href="#id27">Plac easy tests</a><a class="headerlink" href="#plac-easy-tests" title="Permalink to this headline">¶</a></h2>
<p>Writing your tests in terms of <code class="docutils literal notranslate"><span class="pre">Interpreter.check</span></code> is certainly an
improvement over writing them in terms of <code class="docutils literal notranslate"><span class="pre">plac.call</span></code>, but they
are still too low-level for my taste. The <code class="docutils literal notranslate"><span class="pre">Interpreter</span></code> class provides
support for doctest-style tests, a.k.a. <em>plac easy tests</em>.</p>
<p>By using plac easy tests you can cut and paste your interactive session and
turn it into a runnable automatics test.
Consider for instance the following file <code class="docutils literal notranslate"><span class="pre">ishelve.placet</span></code> (the <code class="docutils literal notranslate"><span class="pre">.placet</span></code>
extension is a mnemonic for “plac easy tests”):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!ishelve.py</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">clear</span> <span class="c1"># start from a clean state</span>
<span class="n">cleared</span> <span class="n">the</span> <span class="n">shelve</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span>
<span class="n">setting</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="n">a</span>
<span class="mi">1</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="k">del</span> <span class="n">a</span>
<span class="n">deleted</span> <span class="n">a</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="n">a</span>
<span class="n">a</span><span class="p">:</span> <span class="ow">not</span> <span class="n">found</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">cler</span> <span class="c1"># spelling error</span>
<span class="o">.</span><span class="n">cler</span><span class="p">:</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p>Notice the presence of the shebang line containing the name of the
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> tool to test (a <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> tool is just a Python module with a
function called <code class="docutils literal notranslate"><span class="pre">main</span></code>). The shebang is ignored by the interpreter
(it looks like a comment to it) but it is there so that external
tools (say a test runner) can infer the plac interpreter
to use to test the file.</p>
<p>You can run the <code class="docutils literal notranslate"><span class="pre">ishelve.placet</span></code> file by calling the
<code class="docutils literal notranslate"><span class="pre">.doctest</span></code> method of the interpreter, as in this example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -c &quot;import plac, ishelve
plac.Interpreter(ishelve.main).doctest(open(&#39;ishelve.placet&#39;), verbose=True)&quot;
</pre></div>
</div>
<p>Internally <code class="docutils literal notranslate"><span class="pre">Interpreter.doctests</span></code> invokes something like <code class="docutils literal notranslate"><span class="pre">Interpreter.check</span></code>
multiple times inside the same context and compares the output with the
expected output: if even one check fails, the whole test fail.</p>
<p>You should realize that the easy tests supported by <code class="docutils literal notranslate"><span class="pre">plac</span></code> are <em>not</em>
unittests: they are functional tests. They model the user interaction and the
order of the operations generally matters.  The single subtests in a
<code class="docutils literal notranslate"><span class="pre">.placet</span></code> file are not independent and it makes sense to exit
immediately at the first failure.</p>
<p>The support for doctests in <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> comes nearly for free, thanks to the
<a class="reference external" href="http://docs.python.org/library/shlex.html">shlex</a> module in the standard library, which is able to parse simple
languages as the ones you can implement with <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>. In particular,
thanks to <a class="reference external" href="http://docs.python.org/library/shlex.html">shlex</a>, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is able to recognize comments (the default
comment character is <code class="docutils literal notranslate"><span class="pre">#</span></code>), escape sequences and more. Look at the
<a class="reference external" href="http://docs.python.org/library/shlex.html">shlex</a> documentation if you need to customize how the language is
interpreted. For more flexibility, it is even possible to pass the
interpreter a custom split function with signature <code class="docutils literal notranslate"><span class="pre">split(line,</span>
<span class="pre">commentchar)</span></code>.</p>
<p>In addition, I have implemented some support for line number
recognition, so that if a test fails you get the line number of the
failing command. This is especially useful if your tests are
stored in external files, though they do not need to be in
a file: you can just pass to the <code class="docutils literal notranslate"><span class="pre">.doctest</span></code> method a list of
strings corresponding to the lines of the file.</p>
<p>At the present <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> does not use any code from the doctest
module, but the situation may change in the future (it would be nice
if <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> could reuse doctests directives like ELLIPSIS).</p>
<p>It is straighforward to integrate your <code class="docutils literal notranslate"><span class="pre">.placet</span></code> tests with standard
testing tools. For instance, you can integrate your doctests with <code class="docutils literal notranslate"><span class="pre">nose</span></code>
or <code class="docutils literal notranslate"><span class="pre">py.test</span></code> as follow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shlex</span><span class="o">,</span> <span class="nn">plac</span>

<span class="k">def</span> <span class="nf">test_doct</span><span class="p">():</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Find all the doctests in the current directory and run them with the</span>
<span class="sd">   corresponding plac interpreter (the shebang rules!)</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">placets</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.placet&#39;</span><span class="p">)]</span>
   <span class="k">for</span> <span class="n">placet</span> <span class="ow">in</span> <span class="n">placets</span><span class="p">:</span>
       <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">placet</span><span class="p">))</span>
       <span class="k">assert</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#!&#39;</span><span class="p">),</span> <span class="s1">&#39;Missing or incorrect shebang line!&#39;</span>
       <span class="n">firstline</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span> <span class="c1"># strip the shebang</span>
       <span class="n">main</span> <span class="o">=</span> <span class="n">plac</span><span class="o">.</span><span class="n">import_main</span><span class="p">(</span><span class="o">*</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">firstline</span><span class="p">))</span>
       <span class="k">yield</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">.</span><span class="n">doctest</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
<p>Here you should notice that usage of <code class="docutils literal notranslate"><span class="pre">plac.import_main</span></code>, an utility
which is able to import the main function of the script specified in
the shebang line. You can use both the full path name of the
tool, or a relative path name. In this case the runner looks at the
environment variable <code class="docutils literal notranslate"><span class="pre">PLACPATH</span></code> and it searches
the plac tool in the directories specified there (<code class="docutils literal notranslate"><span class="pre">PLACPATH</span></code> is just
a string containing directory names separated by colons). If the variable
<code class="docutils literal notranslate"><span class="pre">PLACPATH</span></code> is not defined, it just looks in the current directory.
If the plac tool is not found, an <code class="docutils literal notranslate"><span class="pre">ImportError</span></code> is raised.</p>
</div>
<div class="section" id="plac-batch-scripts">
<h2><a class="toc-backref" href="#id28">Plac batch scripts</a><a class="headerlink" href="#plac-batch-scripts" title="Permalink to this headline">¶</a></h2>
<p>It is pretty easy to realize that an interactive interpreter can
also be used to run batch scripts: instead of reading the commands from
the console, it is enough to read the commands from a file.
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> interpreters provide an <code class="docutils literal notranslate"><span class="pre">.execute</span></code> method to perform just that.</p>
<p>There is just a subtle point to notice: whereas in an interactive loop
one wants to manage all exceptions, a batch script should not continue in the
background in case of unexpected errors. The implementation of
<code class="docutils literal notranslate"><span class="pre">Interpreter.execute</span></code> makes sure that any error raised by
<code class="docutils literal notranslate"><span class="pre">plac.call</span></code> internally is re-raised.  In other words, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>
interpreters <em>wrap the errors, but does not eat them</em>: the errors are
always accessible and can be re-raised on demand.</p>
<p>The exception is the case of invalid commands, which are skipped.
Consider for instance the following batch file, which contains a
mispelled command (<code class="docutils literal notranslate"><span class="pre">.dl</span></code> instead of <code class="docutils literal notranslate"><span class="pre">.del</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!ishelve.py</span>
<span class="o">.</span><span class="n">clear</span> 
<span class="n">a</span><span class="o">=</span><span class="mi">1</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span>
<span class="o">.</span><span class="n">show</span>
<span class="o">.</span><span class="k">del</span> <span class="n">a</span>
<span class="o">.</span><span class="n">dl</span> <span class="n">b</span>
<span class="o">.</span><span class="n">show</span>
</pre></div>
</div>
<p>If you execute the batch file, the interpreter will print a <code class="docutils literal notranslate"><span class="pre">.dl:</span> <span class="pre">not</span> <span class="pre">found</span></code>
at the <code class="docutils literal notranslate"><span class="pre">.dl</span></code> line and will continue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -c &quot;import plac, ishelve
plac.Interpreter(ishelve.main).execute(open(&#39;ishelve.plac&#39;), verbose=True)&quot;
i&gt; .clear
cleared the shelve
i&gt; a=1 b=2
setting a=1
setting b=2
i&gt; .show
b=2
a=1
i&gt; .del a
deleted a
i&gt; .dl b
2
.dl: not found
i&gt; .show
b=2
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">verbose</span></code> flag is there to show the lines which are being interpreted
(prefixed by <code class="docutils literal notranslate"><span class="pre">i&gt;</span></code>). This is done on purpose, so that you can cut and paste
the output of the batch script and turn it into a <code class="docutils literal notranslate"><span class="pre">.placet</span></code> test
(cool, isn’t it?).</p>
</div>
<div class="section" id="implementing-subcommands">
<h2><a class="toc-backref" href="#id29">Implementing subcommands</a><a class="headerlink" href="#implementing-subcommands" title="Permalink to this headline">¶</a></h2>
<p>When I discussed the <code class="docutils literal notranslate"><span class="pre">ishelve</span></code> implementation,
I said that it looked like the poor man implementation
of an object system as a chain of elifs; I also said that <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> was
able to do much better than that.  Here I will substantiate my claim.</p>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is actually able to infer a set of subparsers from a
generic container of commands.  This is useful if you want to
implement <em>subcommands</em> (a familiar example of a command-line
application featuring subcommands is version control system).
Technically a container of commands is any object with a <code class="docutils literal notranslate"><span class="pre">.commands</span></code> attribute
listing a set of functions or methods which are valid commands. A command
container may have initialization/finalization hooks (<code class="docutils literal notranslate"><span class="pre">__enter__/__exit__</span></code>)
and dispatch hooks (<code class="docutils literal notranslate"><span class="pre">__missing__</span></code>, invoked for invalid command names).
Moreover, only when using command containers <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is able to provide
automatic <em>autocompletion</em> of commands.</p>
<p>The shelve interface can be rewritten in an object-oriented way as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ishelve2.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">plac</span>


<span class="k">class</span> <span class="nc">ShelveInterface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s2">&quot;A minimal interface over a shelve object.&quot;</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="s1">&#39;showall&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span>

    <span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
        <span class="n">configfile</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;path name of the shelve&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="n">configfile</span> <span class="ow">or</span> <span class="s1">&#39;~/conf.shelve&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Operating on </span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Use help to see &#39;</span>
                         <span class="s1">&#39;the available commands.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s2">&quot;set name value&quot;</span>
        <span class="k">yield</span> <span class="s1">&#39;setting </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="s2">&quot;show given parameters&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>  <span class="c1"># no error checking</span>

    <span class="k">def</span> <span class="nf">showall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;show all parameters&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="s2">&quot;delete given parameter (or everything)&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s1">&#39;deleting everything&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s1">&#39;deleting </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>  <span class="c1"># no error checking</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ShelveInterface</span><span class="p">))</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">plac.Interpreter</span></code> objects wrap context manager objects
consistently.  In other words, if you wrap an object with
<code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> methods, they are invoked in the right
order (<code class="docutils literal notranslate"><span class="pre">__enter__</span></code> before the interpreter loop starts and
<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> after the interpreter loop ends, both in the regular and
in the exceptional case). In our example, the methods <code class="docutils literal notranslate"><span class="pre">__enter__</span></code>
and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> make sure the the shelve is opened and closed
correctly even in the case of exceptions. Notice that I have not
implemented any error checking in the <code class="docutils literal notranslate"><span class="pre">show</span></code> and <code class="docutils literal notranslate"><span class="pre">delete</span></code> methods
on purpose, to verify that <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> works correctly in the presence of
exceptions.</p>
<p>When working with command containers, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> automatically adds two
special commands to the set of provided commands: <code class="docutils literal notranslate"><span class="pre">help</span></code>
and <code class="docutils literal notranslate"><span class="pre">.last_tb</span></code>. The <code class="docutils literal notranslate"><span class="pre">help</span></code> command is the easier to understand:
when invoked without arguments it displays the list of available commands
with the same formatting of the <a class="reference external" href="http://docs.python.org/library/cmd.html">cmd</a> module; when invoked with the name of
a command it displays the usage message for that command.
The <code class="docutils literal notranslate"><span class="pre">.last_tb</span></code> command is useful when debugging: in case of errors,
it allows you to display the traceback of the last executed command.</p>
<p>Here is the usage message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">ishelve2</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">configfile</span> <span class="n">CONFIGFILE</span><span class="p">]</span>

<span class="n">A</span> <span class="n">minimal</span> <span class="n">interface</span> <span class="n">over</span> <span class="n">a</span> <span class="n">shelve</span> <span class="nb">object</span><span class="o">.</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">configfile</span> <span class="n">CONFIGFILE</span>
                        <span class="n">path</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">shelve</span>
</pre></div>
</div>
<p>Here is a session of usage on an Unix-like operating system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python ishelve2.py -c ~/test.shelve
A minimal interface over a shelve object.
Operating on /home/micheles/test.shelve.
Use help to see the available commands.
i&gt; help

special commands
================
.last_tb

custom commands
===============
delete  set  show  showall

i&gt; delete
deleting everything
i&gt; set a pippo
setting a=pippo
i&gt; set b lippo
setting b=lippo
i&gt; showall
b = lippo
a = pippo
i&gt; show a b
a = pippo
b = lippo
i&gt; del a
deleting a
i&gt; showall
b = lippo
i&gt; delete a
deleting a
KeyError: &#39;a&#39;
i&gt; .last_tb
 File &quot;/usr/local/lib/python2.6/dist-packages/plac-0.6.0-py2.6.egg/plac_ext.py&quot;, line 190, in _wrap
    for value in genobj:
  File &quot;./ishelve2.py&quot;, line 37, in delete
    del self.sh[name] # no error checking
  File &quot;/usr/lib/python2.6/shelve.py&quot;, line 136, in __delitem__
    del self.dict[key]
i&gt;
</pre></div>
</div>
<p>Notice that in interactive mode the traceback is hidden, unless
you pass the <code class="docutils literal notranslate"><span class="pre">verbose</span></code> flag to the <code class="docutils literal notranslate"><span class="pre">Interpreter.interact</span></code> method.</p>
<p>CHANGED IN VERSION 0.9: if you have an old version of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> the
<code class="docutils literal notranslate"><span class="pre">help</span></code> command must be prefixed with a dot, i.e. you must write
<code class="docutils literal notranslate"><span class="pre">.help</span></code>. The old behavior was more consistent in my opinion, since
it made it clear that the <code class="docutils literal notranslate"><span class="pre">help</span></code> command was special and threated
differently from the regular commands.
Notice that if you implement a custom <code class="docutils literal notranslate"><span class="pre">help</span></code> command in the commander class
the default help will not be added, as you would expect.</p>
<p>In version 0.9 an exception <code class="docutils literal notranslate"><span class="pre">`plac.Interpreter.Exit</span></code> was added. Its
purpose is to make it easy to define commands to exit from the command
loop. Just define something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
   <span class="k">raise</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="o">.</span><span class="n">Exit</span>
</pre></div>
</div>
<p>and the interpreter will be closed properly when the <code class="docutils literal notranslate"><span class="pre">quit</span></code> command
is entered.</p>
</div>
<div class="section" id="plac-interpreter-call">
<h2><a class="toc-backref" href="#id30">plac.Interpreter.call</a><a class="headerlink" href="#plac-interpreter-call" title="Permalink to this headline">¶</a></h2>
<p>At the core of <code class="docutils literal notranslate"><span class="pre">plac</span></code> there is the <code class="docutils literal notranslate"><span class="pre">call</span></code> function which invokes
a callable with the list of arguments passed at the command-line
(<code class="docutils literal notranslate"><span class="pre">sys.argv[1:]</span></code>). Thanks to <code class="docutils literal notranslate"><span class="pre">plac.call</span></code> you can launch your module
by simply adding the lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Everything works fine if <code class="docutils literal notranslate"><span class="pre">main</span></code> is a simple callable performing some
action; however, in many cases, one has a <code class="docutils literal notranslate"><span class="pre">main</span></code> “function” which
is a actually a factory returning a command container object. For
instance, in my second shelve example the main function is the class
<code class="docutils literal notranslate"><span class="pre">ShelveInterface</span></code>, and the two lines needed to run the module are
a bit ugly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ShelveInterface</span><span class="p">))</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</pre></div>
</div>
<p>Moreover, now the program runs, but only in interactive mode, i.e.
it is not possible to run it as a script. Instead, it would be nice
to be able to specify the command to execute on the command-line
and have the interpreter start, execute the command and finish
properly (I mean by calling <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>)
without needing user input. Then the script could be called from
a batch shell script working in the background.
In order to provide such functionality <code class="docutils literal notranslate"><span class="pre">plac.Interpreter</span></code> provides
a classmethod named <code class="docutils literal notranslate"><span class="pre">.call</span></code> which takes the factory, instantiates
it with the arguments read from the command line, wraps the resulting
container object as an interpreter and runs it with the remaining arguments
found in the command line. Here is the code to turn the <code class="docutils literal notranslate"><span class="pre">ShelveInterface</span></code>
into a script</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ishelve3.py</span>
<span class="kn">from</span> <span class="nn">ishelve2</span> <span class="kn">import</span> <span class="n">ShelveInterface</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ShelveInterface</span><span class="p">)</span>

<span class="c1">## try the following:</span>
<span class="c1"># $ python ishelve3.py delete</span>
<span class="c1"># $ python ishelve3.py set a 1</span>
<span class="c1"># $ python ishelve3.py showall</span>
</pre></div>
</div>
<p>and here are a few examples of usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python ishelve3.py help

special commands
================
.last_tb

custom commands
===============
delete  set  show  showall

$ python ishelve3.py set a 1
setting a=1
$ python ishelve3.py show a
a = 1
</pre></div>
</div>
<p>If you pass the <code class="docutils literal notranslate"><span class="pre">-i</span></code> flag in the command line, then the
script will enter in interactive mode and ask the user
for the commands to execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python ishelve3.py -i
A minimal interface over a shelve object.
Operating on /home/micheles/conf.shelve.
Use help to see the available commands.

i&gt;
</pre></div>
</div>
<p>In a sense, I have closed the circle: at the beginning of this
document I discussed how to turn a script into an interactive
application (the <code class="docutils literal notranslate"><span class="pre">shelve_interpreter.py</span></code> example), whereas here I
have show how to turn an interactive application into a script.</p>
<p>The complete signature of <code class="docutils literal notranslate"><span class="pre">plac.Interpreter.call</span></code> is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">call</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">arglist</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
     <span class="n">commentchar</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">,</span>
     <span class="n">stdin</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s1">&#39;i&gt; &#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>The factory must have a fixed number of positional arguments (no
default arguments, no varargs, no kwargs), otherwise a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code>
is raised: the reason is that we want to be able to distinguish the
command-line arguments needed to instantiate the factory from the remaining
arguments that must be sent to the corresponding interpreter object.
It is also possible to specify a list of arguments different from
<code class="docutils literal notranslate"><span class="pre">sys.argv[1:]</span></code> (useful in tests), the character to be recognized as
a comment, the splitting function, the input source, the prompt to
use while in interactive mode, and a verbose flag.</p>
</div>
<div class="section" id="readline-support">
<h2><a class="toc-backref" href="#id31">Readline support</a><a class="headerlink" href="#readline-support" title="Permalink to this headline">¶</a></h2>
<p>Starting from release 0.6 <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> offers full readline support. That
means that if your Python was compiled with readline support you get
autocompletion and persistent command history for free.  By default
all commands autocomplete in a case sensitive way.  If you want to
add new words to the autocompletion set, or you want to change the
location of the <code class="docutils literal notranslate"><span class="pre">.history</span></code> file, or to change the case sensitivity,
the way to go is to pass a <code class="docutils literal notranslate"><span class="pre">plac.ReadlineInput</span></code> object to the
interpreter.  Here is an example, assuming you want to build a
database interface understanding SQL commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">plac</span>
<span class="kn">from</span> <span class="nn">sqlsoup</span> <span class="kn">import</span> <span class="n">SQLSoup</span>

<span class="n">SQLKEYWORDS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="s1">&#39;outer&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">])</span>  <span class="c1"># and many others</span>

<span class="n">DBTABLES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;table1&#39;</span><span class="p">,</span> <span class="s1">&#39;table2&#39;</span><span class="p">])</span>  <span class="c1"># you can read them from the db schema</span>

<span class="n">COMPLETIONS</span> <span class="o">=</span> <span class="n">SQLKEYWORDS</span> <span class="o">|</span> <span class="n">DBTABLES</span>


<span class="k">class</span> <span class="nc">SqlInterface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soup</span> <span class="o">=</span> <span class="n">SQLSoup</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SELECT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argstring</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT &#39;</span> <span class="o">+</span> <span class="n">argstring</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
            <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>  <span class="c1"># the formatting can be much improved</span>


<span class="n">rl_input</span> <span class="o">=</span> <span class="n">plac</span><span class="o">.</span><span class="n">ReadlineInput</span><span class="p">(</span>
    <span class="n">COMPLETIONS</span><span class="p">,</span> <span class="n">histfile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.sql_interface.history&#39;</span><span class="p">),</span>
    <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">split_on_first_space</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">commentchar</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ignoring comments</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">SqlInterface</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split_on_first_space</span><span class="p">,</span>
                          <span class="n">stdin</span><span class="o">=</span><span class="n">rl_input</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s1">&#39;sql&gt; &#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is an example of usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python sql_interface.py &lt;some dsn&gt;
sql&gt; SELECT a.* FROM TABLE1 AS a INNER JOIN TABLE2 AS b ON a.id = b.id
...
</pre></div>
</div>
<p>You can check that entering just <code class="docutils literal notranslate"><span class="pre">sel</span></code> and pressing TAB the readline library
completes the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> keyword for you and makes it upper case; idem for
<code class="docutils literal notranslate"><span class="pre">FROM</span></code>, <code class="docutils literal notranslate"><span class="pre">INNER</span></code>, <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> and even for the names of the tables. An
obvious improvement is to read the names of the tables by introspecting
the database: actually you can even read the names of the views and
the columns, and get full autocompletion. All the entered commands
are recorded and saved in the file <code class="docutils literal notranslate"><span class="pre">~/.sql_interface.history</span></code> when
exiting from the command-line interface.</p>
<p>If the readline library is not available, my suggestion is to use the
<a class="reference external" href="http://freshmeat.net/projects/rlwrap/">rlwrap</a> tool which provides similar features, at least on Unix-like
platforms. <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> should also work fine on Windows with the <a class="reference external" href="http://ipython.scipy.org/moin/PyReadline/Intro">pyreadline</a>
library (I do not use Windows, so this part is very little tested: I
tried it only once and it worked, but your mileage may vary).
For people worried about licenses, I will notice that <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> uses the
readline library only if available, it does not include it and it does
not rely on it in any fundamental way, so that the <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> licence does
not need to be the GPL (actually it is a BSD
do-whatever-you-want-with-it licence).</p>
<p>The interactive mode of <code class="docutils literal notranslate"><span class="pre">plac</span></code> can be used as a replacement of the
<a class="reference external" href="http://docs.python.org/library/cmd.html">cmd</a> module in the standard library. It is actually better than <a class="reference external" href="http://docs.python.org/library/cmd.html">cmd</a>:
for instance, the <code class="docutils literal notranslate"><span class="pre">help</span></code> command is more powerful, since it
provides information about the arguments accepted by the given command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="n">help</span> <span class="nb">set</span>
<span class="n">usage</span><span class="p">:</span>  <span class="nb">set</span> <span class="n">name</span> <span class="n">value</span>

<span class="nb">set</span> <span class="n">name</span> <span class="n">value</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">name</span>
  <span class="n">value</span>

<span class="n">i</span><span class="o">&gt;</span> <span class="n">help</span> <span class="n">delete</span>
<span class="n">usage</span><span class="p">:</span>  <span class="n">delete</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="n">delete</span> <span class="n">given</span> <span class="n">parameter</span> <span class="p">(</span><span class="ow">or</span> <span class="n">everything</span><span class="p">)</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">name</span>        <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

<span class="n">i</span><span class="o">&gt;</span> <span class="n">help</span> <span class="n">show</span>
<span class="n">usage</span><span class="p">:</span>  <span class="n">show</span> <span class="p">[</span><span class="n">names</span> <span class="p">[</span><span class="n">names</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">show</span> <span class="n">given</span> <span class="n">parameters</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">names</span>
</pre></div>
</div>
<p>As you can imagine, the help message is provided by the underlying <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a>
subparser: there is a subparser for each command. <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> commands accept
options, flags, varargs, keyword arguments, arguments with defaults,
arguments with a fixed number of choices, type conversion and all the
features provided of <a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> .</p>
<p>Moreover at the moment <code class="docutils literal notranslate"><span class="pre">plac</span></code> also understands command abbreviations.
However, this feature may disappear in
future releases. It was meaningful in the past, when <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> did not support
readline.</p>
<p>Notice that if an abbreviation is ambiguous, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> warns you:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="n">sh</span>
<span class="ne">NameError</span><span class="p">:</span> <span class="n">Ambiguous</span> <span class="n">command</span> <span class="s1">&#39;sh&#39;</span><span class="p">:</span> <span class="n">matching</span> <span class="p">[</span><span class="s1">&#39;showall&#39;</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="the-plac-runner">
<h2><a class="toc-backref" href="#id32">The plac runner</a><a class="headerlink" href="#the-plac-runner" title="Permalink to this headline">¶</a></h2>
<p>The distribution of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> includes a runner script named <code class="docutils literal notranslate"><span class="pre">plac_runner.py</span></code>,
which will be installed in a suitable directory in your system by <a class="reference external" href="http://docs.python.org/distutils/">distutils</a>
(say in <code class="docutils literal notranslate"><span class="pre">/usr/local/bin/plac_runner.py</span></code> in a Unix-like operative system).
The runner provides many facilities to run <code class="docutils literal notranslate"><span class="pre">.plac</span></code> scripts and
<code class="docutils literal notranslate"><span class="pre">.placet</span></code> files, as well as Python modules containg a <code class="docutils literal notranslate"><span class="pre">main</span></code>
object, which can be a function, a command container object or
even a command container class.</p>
<p>For instance, suppose you want to execute a script containing commands
defined in the <code class="docutils literal notranslate"><span class="pre">ishelve2</span></code> module like the following one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!ishelve2.py:ShelveInterface -c ~/conf.shelve</span>
<span class="nb">set</span> <span class="n">a</span> <span class="mi">1</span>
<span class="k">del</span> <span class="n">a</span>
<span class="k">del</span> <span class="n">a</span> <span class="c1"># intentional error</span>
</pre></div>
</div>
<p>The first line of the <code class="docutils literal notranslate"><span class="pre">.plac</span></code> script contains the name of the
python module containing the plac interpreter and the arguments
which must be passed to its main function in order to be able
to instantiate an interpreter object. In this case I appended
<code class="docutils literal notranslate"><span class="pre">:ShelveInterface</span></code> to the name of the module to specify the
object that must be imported: if not specified, by default the
object named ‘main’ is imported.
The other lines contains commands.
You can run the script as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ plac_runner.py --batch ishelve2.plac
setting a=1
deleting a
Traceback (most recent call last):
  ...
_bsddb.DBNotFoundError: (-30988, &#39;DB_NOTFOUND: No matching key/data pair found&#39;)
</pre></div>
</div>
<p>The last command intentionally contained an error, to show that the
plac runner does not eat the traceback.</p>
<p>The runner can also be used to run Python modules in interactive
mode and non-interactive mode. If you put this alias in your bashrc</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">alias</span> <span class="pre">plac=&quot;plac_runner.py&quot;</span></code></p>
</div></blockquote>
<p>(or you define a suitable <code class="docutils literal notranslate"><span class="pre">plac.bat</span></code> script in Windows) you can
run the <code class="docutils literal notranslate"><span class="pre">ishelve2.py</span></code> script in interactive mode as
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ plac -i ishelve2.py:ShelveInterface
A minimal interface over a shelve object.
Operating on /home/micheles/conf.shelve.
.help to see the available commands.

i&gt; del
deleting everything
i&gt; set a 1
setting a=1
i&gt; set b 2
setting b=2
i&gt; show b
b = 2
</pre></div>
</div>
<p>Now you can cut and paste the interactive session and turn it into
a <code class="docutils literal notranslate"><span class="pre">.placet</span></code> file like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!ishelve2.py:ShelveInterface -configfile=~/test.shelve</span>
<span class="c1"># an example of a .placet file for the ShelveInterface</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="k">del</span>
<span class="n">deleting</span> <span class="n">everything</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="nb">set</span> <span class="n">a</span> <span class="mi">1</span>
<span class="n">setting</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="nb">set</span> <span class="n">b</span> <span class="mi">2</span>
<span class="n">setting</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">a</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Notice that the first line specifies a test database
<code class="docutils literal notranslate"><span class="pre">~/test.shelve</span></code>, to avoid clobbering your default shelve. If you
mispell the arguments in the first line plac will give you an
<a class="reference external" href="https://docs.python.org/3/library/argparse.html">argparse</a> error message (just try).</p>
<p>You can run placets following the shebang convention directly with
the plac runner:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ plac --test ishelve2.placet
run 1 plac test(s)
</pre></div>
</div>
<p>If you want to see the output of the tests, pass the <code class="docutils literal notranslate"><span class="pre">-v/--verbose</span></code> flag.
Notice that he runner ignores the extension, so you can actually use any
extension your like, but <em>it relies on the first line of the file to invoke
the corresponding plac tool with the given arguments</em>.</p>
<p>The plac runner does not provide any test discovery facility,
but you can use standard Unix tools to help. For instance, you can
run all the <code class="docutils literal notranslate"><span class="pre">.placet</span></code> files into a directory and its subdirectories
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ find . -name \*.placet | xargs plac_runner.py -t
</pre></div>
</div>
<p>The plac runner expects the main function of your script to
return a plac tool, i.e. a function or an object with a <code class="docutils literal notranslate"><span class="pre">.commands</span></code>
attribute. If this is not the case the runner exits gracefully.</p>
<p>It also works in non-interactive mode, if you call it as</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">plac</span> <span class="pre">module.py</span> <span class="pre">args</span> <span class="pre">...</span></code></p>
</div></blockquote>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ plac ishelve.py a=1
setting a=1
$ plac ishelve.py .show
a=1
</pre></div>
</div>
<p>Notice that in non-interactive mode the runner just invokes <code class="docutils literal notranslate"><span class="pre">plac.call</span></code>
on the <code class="docutils literal notranslate"><span class="pre">main</span></code> object of the Python module.</p>
</div>
<div class="section" id="a-non-class-based-example">
<h2><a class="toc-backref" href="#id33">A non class-based example</a><a class="headerlink" href="#a-non-class-based-example" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> does not force you to use classes to define command containers.
Even a simple function can be a valid command container, it is
enough to add a <code class="docutils literal notranslate"><span class="pre">.commands</span></code> attribute to it, and possibly
<code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and/or <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> attributes too.</p>
<p>In particular, a Python module is a perfect container of commands. As an
example, consider the following module implementing a fake Version
Control System:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;A Fake Version Control System&quot;</span>

<span class="kn">import</span> <span class="nn">plac</span>  <span class="c1"># this implementation also works with Python 2.4</span>

<span class="n">commands</span> <span class="o">=</span> <span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;commit&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;url of the source code&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="s2">&quot;A fake checkout command&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;checkout &#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;commit message&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="s2">&quot;A fake commit command&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;commit &#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>


<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;summary information&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">quiet</span><span class="p">):</span>
    <span class="s2">&quot;A fake status command&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;status &#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="p">)</span>


<span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Command </span><span class="si">%r</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,)</span>


<span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
    <span class="s2">&quot;Will be called automatically at the end of the intepreter loop&quot;</span>
    <span class="k">if</span> <span class="n">etype</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="ne">GeneratorExit</span><span class="p">):</span>  <span class="c1"># success</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>

<span class="n">main</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># the module imports itself!</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span>
    <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.1.0&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that I have defined both an <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> hook and a <code class="docutils literal notranslate"><span class="pre">__missing__</span></code>
hook, invoked for non-existing commands.
The real trick here is the line <code class="docutils literal notranslate"><span class="pre">main</span> <span class="pre">=</span> <span class="pre">__import__(__name__)</span></code>, which
define <code class="docutils literal notranslate"><span class="pre">main</span></code> to be an alias for the current module.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">vcs</span></code> module can be run through the plac runner
(try <code class="docutils literal notranslate"><span class="pre">plac</span> <span class="pre">vcs.py</span> <span class="pre">-h</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">plac_runner</span><span class="o">.</span><span class="n">py</span> <span class="n">vcs</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">commit</span><span class="p">,</span><span class="n">checkout</span><span class="p">}</span> <span class="o">...</span>

<span class="n">A</span> <span class="n">Fake</span> <span class="n">Version</span> <span class="n">Control</span> <span class="n">System</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>

<span class="n">subcommands</span><span class="p">:</span>
  <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">commit</span><span class="p">,</span><span class="n">checkout</span><span class="p">}</span>
    <span class="n">checkout</span>            <span class="n">A</span> <span class="n">fake</span> <span class="n">checkout</span> <span class="n">command</span>
    <span class="n">commit</span>              <span class="n">A</span> <span class="n">fake</span> <span class="n">commit</span> <span class="n">command</span>
    <span class="n">status</span>              <span class="n">A</span> <span class="n">fake</span> <span class="n">status</span> <span class="n">command</span>
</pre></div>
</div>
<p>You can get help for the subcommands by inserting an <code class="docutils literal notranslate"><span class="pre">-h</span></code> after the
name of the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ plac vcs.py status -h
usage: plac_runner.py vcs.py status [-h] [-q]

A fake status command

optional arguments:
  -h, --help   show this help message and exit
  -q, --quiet  summary information
</pre></div>
</div>
<p>Notice how the docstring of the command is automatically shown in the
usage message, as well as the documentation for the sub flag <code class="docutils literal notranslate"><span class="pre">-q</span></code>.</p>
<p>Here is an example of a non-interactive session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ plac vcs.py check url
checkout
url
$ plac vcs.py st -q
status
True
$ plac vcs.py co
commit
None
</pre></div>
</div>
<p>and here is an interactive session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ plac -i vcs.py
usage: plac_runner.py vcs.py [-h] {status,commit,checkout} ...
i&gt; check url
checkout
url
i&gt; st -q
status
True
i&gt; co
commit
None
i&gt; sto
Command &#39;sto&#39; does not exist
i&gt; [CTRL-D]
ok
</pre></div>
</div>
<p>Notice the invocation of the <code class="docutils literal notranslate"><span class="pre">__missing__</span></code> hook for non-existing commands.
Notice also that the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> hook gets called only in interactive
mode.</p>
<p>If the commands are completely independent, a module is a good fit for
a method container. In other situations, it is best to use a custom
class.</p>
</div>
<div class="section" id="writing-your-own-plac-runner">
<h2><a class="toc-backref" href="#id34">Writing your own plac runner</a><a class="headerlink" href="#writing-your-own-plac-runner" title="Permalink to this headline">¶</a></h2>
<p>The runner included in the <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> distribution is intentionally kept
small (around 50 lines of code) so that you can study it and write
your own runner if you want to. If you need to go to such level
of detail, you should know that the most important method of
the <code class="docutils literal notranslate"><span class="pre">Interpreter</span></code> class is the <code class="docutils literal notranslate"><span class="pre">.send</span></code> method, which takes
strings as input and returns a four elements tuple with attributes
<code class="docutils literal notranslate"><span class="pre">.str</span></code>, <code class="docutils literal notranslate"><span class="pre">.etype</span></code>, <code class="docutils literal notranslate"><span class="pre">.exc</span></code> and <code class="docutils literal notranslate"><span class="pre">.tb</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.str</span></code> is the output of the command, if successful (a string);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.etype</span></code> is the class of the exception, if the command fails;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.exc</span></code> is the exception instance;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.tb</span></code> is the traceback.</p></li>
</ul>
<p>Moreover, the <code class="docutils literal notranslate"><span class="pre">__str__</span></code> representation of the output object is redefined
to return the output string if the command was successful, or the error
message (preceded by the name of the exception class) if the command failed.</p>
<p>For instance, if you send a mispelled option to
the interpreter a <code class="docutils literal notranslate"><span class="pre">SystemExit</span></code> will be trapped:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">plac</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ishelve</span> <span class="kn">import</span> <span class="n">ishelve</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">ishelve</span><span class="p">)</span> <span class="k">as</span> <span class="n">i</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;.cler&#39;</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go">SystemExit: unrecognized arguments: .cler</span>
</pre></div>
</div>
<p>It is important to invoke the <code class="docutils literal notranslate"><span class="pre">.send</span></code> method inside the context manager,
otherwise you will get a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>.</p>
<p>For instance, suppose you want to implement a graphical runner for a
plac-based interpreter with two text widgets: one to enter the commands
and one to display the results. Suppose you want to display the errors
with tracebacks in red. You will need to code something like that
(pseudocode follows):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">input_widget</span> <span class="o">=</span> <span class="n">WidgetReadingInput</span><span class="p">()</span>
<span class="n">output_widget</span> <span class="o">=</span> <span class="n">WidgetDisplayingOutput</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">interpreter</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">tb</span><span class="p">:</span> <span class="c1"># there was an error</span>
        <span class="n">output_widget</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">tb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_widget</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">str</span><span class="p">)</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">plac</span><span class="o">.</span><span class="n">import_main</span><span class="p">(</span><span class="n">tool_path</span><span class="p">)</span> <span class="c1"># get the main object</span>

<span class="k">with</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">main</span><span class="p">)</span> <span class="k">as</span> <span class="n">i</span><span class="p">:</span>
   <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">user_pressed_ENTER</span><span class="p">():</span>
           <span class="n">send</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">input_widget</span><span class="o">.</span><span class="n">last_line</span><span class="p">)</span>
   <span class="n">input_widget</span><span class="o">.</span><span class="n">addcallback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
   <span class="n">gui_mainloop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>You can adapt the pseudocode to your GUI toolkit of choice and you can
also change the file associations in such a way that the graphical user
interface starts when clicking on a plac tool file.</p>
<p>An example of a GUI program built on top of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is given later on, in the
paragraph <em>Managing the output of concurrent commands</em> (using Tkinter
for simplicity and portability).</p>
<p>There is a final <em>caveat</em>: since the plac interpreter loop is
implemented via extended generators, plac interpreters are single threaded: you
will get an error if you <code class="docutils literal notranslate"><span class="pre">.send</span></code> commands from separated threads.
You can circumvent the problem by using a queue. If EXIT is a sentinel
value to signal exiting from the interpreter loop, you can write code
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">interpreter</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">input_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">EXIT</span><span class="p">):</span>
        <span class="n">output_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">interpreter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">input_value</span><span class="p">))</span>
</pre></div>
</div>
<p>The same trick also works for processes; you could run the interpreter
loop in a separate process and send commands to it via the Queue
class provided by the <a class="reference external" href="http://docs.python.org/library/multiprocessing.html">multiprocessing</a> module.</p>
</div>
<div class="section" id="long-running-commands">
<h2><a class="toc-backref" href="#id35">Long running commands</a><a class="headerlink" href="#long-running-commands" title="Permalink to this headline">¶</a></h2>
<p>As we saw, by default a <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> interpreter blocks until
the command terminates. This is an issue, in the sense that it makes
the interactive experience quite painful for long running commands. An
example is better than a thousand words, so consider the following
fake importer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">plac</span>

<span class="k">class</span> <span class="nc">FakeImporter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s2">&quot;A fake importer with an import_file command&quot;</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import_file&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span> <span class="o">=</span> <span class="n">dsn</span>
    <span class="k">def</span> <span class="nf">import_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="s2">&quot;Import a file into the database&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">01</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">99</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Imported </span><span class="si">%d</span><span class="s1"> lines&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;closing the file&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">FakeImporter</span><span class="p">)</span>
</pre></div>
</div>
<p>If you run the <code class="docutils literal notranslate"><span class="pre">import_file</span></code> command, you will have to wait for 200 seconds
before entering a new command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python importer1.py dsn -i
A fake importer with an import_file command
i&gt; import_file file1
... &lt;wait 3+ minutes&gt;
Imported 100 lines
Imported 200 lines
Imported 300 lines
...
Imported 10000 lines
closing the file
</pre></div>
</div>
<p>Being unable to enter any other command is quite annoying: in such situation one
would like to run the long running commands in the background, to keep
the interface responsive. <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> provides two ways to reach this goal: threads
and processes.</p>
</div>
<div class="section" id="threaded-commands">
<h2><a class="toc-backref" href="#id36">Threaded commands</a><a class="headerlink" href="#threaded-commands" title="Permalink to this headline">¶</a></h2>
<p>The most familiar way to execute a task in the background (even if not
necessarily the best way) is to run it into a separate thread. In our
example it is sufficient to replace the line</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">commands</span> <span class="pre">=</span> <span class="pre">['import_file']</span></code></p>
</div></blockquote>
<p>with</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">thcommands</span> <span class="pre">=</span> <span class="pre">['import_file']</span></code></p>
</div></blockquote>
<p>to tell to the <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> interpreter that the command <code class="docutils literal notranslate"><span class="pre">import_file</span></code> should be
run into a separated thread. Here is an example session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="n">import_file</span> <span class="n">file1</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">1</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file1</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The import task started in a separated thread. You can see the
progress of the task by using the special command <code class="docutils literal notranslate"><span class="pre">.output</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">output</span> <span class="mi">1</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">1</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file1</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
<span class="n">Imported</span> <span class="mi">100</span> <span class="n">lines</span>
<span class="n">Imported</span> <span class="mi">200</span> <span class="n">lines</span>
</pre></div>
</div>
<p>If you look after a while, you will get more lines of output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">output</span> <span class="mi">1</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">1</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file1</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
<span class="n">Imported</span> <span class="mi">100</span> <span class="n">lines</span>
<span class="n">Imported</span> <span class="mi">200</span> <span class="n">lines</span>
<span class="n">Imported</span> <span class="mi">300</span> <span class="n">lines</span>
<span class="n">Imported</span> <span class="mi">400</span> <span class="n">lines</span>
</pre></div>
</div>
<p>If you look after a time long enough, the task will be finished:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">output</span> <span class="mi">1</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">1</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file1</span><span class="p">]</span> <span class="n">FINISHED</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>It is possible to store the output of a task into a file, to be read
later (this is useful for tasks with a large output):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">output</span> <span class="mi">1</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">out</span><span class="o">.</span><span class="n">txt</span>
<span class="n">saved</span> <span class="n">output</span> <span class="n">of</span> <span class="mi">1</span> <span class="n">into</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">out</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>You can even skip the number argument: then <code class="docutils literal notranslate"><span class="pre">.output</span></code> will the return
the output of the last launched command (the special commands like .output
do not count).</p>
<p>You can launch many tasks one after the other:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="n">import_file</span> <span class="n">file2</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">5</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file2</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="n">import_file</span> <span class="n">file3</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">6</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file3</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.list</span></code> command displays all the running tasks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">list</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">5</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file2</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">6</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file3</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>It is even possible to kill a task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">kill</span> <span class="mi">5</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">5</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file2</span><span class="p">]</span> <span class="n">TOBEKILLED</span><span class="o">&gt;</span>
<span class="c1"># wait a bit ...</span>
<span class="n">closing</span> <span class="n">the</span> <span class="n">file</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">output</span> <span class="mi">5</span>
<span class="o">&lt;</span><span class="n">ThreadedTask</span> <span class="mi">5</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file2</span><span class="p">]</span> <span class="n">KILLED</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Note that since at the Python level it is impossible to kill
a thread, the <code class="docutils literal notranslate"><span class="pre">.kill</span></code> command works by setting the status of the task to
<code class="docutils literal notranslate"><span class="pre">TOBEKILLED</span></code>. Internally the generator corresponding to the command
is executed in the thread and the status is checked at each iteration:
when the status becomes <code class="docutils literal notranslate"><span class="pre">TOBEKILLED</span></code>, a <code class="docutils literal notranslate"><span class="pre">GeneratorExit</span></code> exception is
raised and the thread terminates (softly, so that the <code class="docutils literal notranslate"><span class="pre">finally</span></code> clause
is honored). In our example the generator is yielding
back control once every 100 iterations, i.e. every two seconds (not much).
In order to get a responsive interface it is a good idea to yield more
often, for instance every 10 iterations (i.e. 5 times per second),
as in the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">plac</span>

<span class="k">class</span> <span class="nc">FakeImporter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s2">&quot;A fake importer with an import_file command&quot;</span>
    <span class="n">thcommands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import_file&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsn</span> <span class="o">=</span> <span class="n">dsn</span>
    <span class="k">def</span> <span class="nf">import_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="s2">&quot;Import a file into the database&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">02</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">99</span><span class="p">:</span> <span class="c1"># every two seconds</span>
                    <span class="k">yield</span> <span class="s1">&#39;Imported </span><span class="si">%d</span><span class="s1"> lines&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span> <span class="c1"># every 0.2 seconds</span>
                    <span class="k">yield</span> <span class="c1"># go back and check the TOBEKILLED status</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;closing the file&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">FakeImporter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="running-commands-as-external-processes">
<h2><a class="toc-backref" href="#id37">Running commands as external processes</a><a class="headerlink" href="#running-commands-as-external-processes" title="Permalink to this headline">¶</a></h2>
<p>Threads are not loved much in the Python world and actually most people
prefer to use processes instead. For this reason <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> provides the
option to execute long running commands as external processes. Unfortunately
the current implementation only works on Unix-like operating systems
(including Mac OS/X) because it relies on fork via the <a class="reference external" href="http://docs.python.org/library/multiprocessing.html">multiprocessing</a>
module.</p>
<p>In our example, to enable the feature it is sufficient to replace the line</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">thcommands</span> <span class="pre">=</span> <span class="pre">['import_file']</span></code></p>
</div></blockquote>
<p>with</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">mpcommands</span> <span class="pre">=</span> <span class="pre">['import_file']</span></code>.</p>
</div></blockquote>
<p>The user experience is exactly the same as with threads and you will not see any
difference at the user interface level:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&gt;</span> <span class="n">import_file</span> <span class="n">file3</span>
<span class="o">&lt;</span><span class="n">MPTask</span> <span class="mi">1</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file3</span><span class="p">]</span> <span class="n">SUBMITTED</span><span class="o">&gt;</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">kill</span> <span class="mi">1</span>
<span class="o">&lt;</span><span class="n">MPTask</span> <span class="mi">1</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file3</span><span class="p">]</span> <span class="n">RUNNING</span><span class="o">&gt;</span>
<span class="n">closing</span> <span class="n">the</span> <span class="n">file</span>
<span class="n">i</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">output</span> <span class="mi">1</span>
<span class="o">&lt;</span><span class="n">MPTask</span> <span class="mi">1</span> <span class="p">[</span><span class="n">import_file</span> <span class="n">file3</span><span class="p">]</span> <span class="n">KILLED</span><span class="o">&gt;</span>
<span class="n">Imported</span> <span class="mi">100</span> <span class="n">lines</span>
<span class="n">Imported</span> <span class="mi">200</span> <span class="n">lines</span>
<span class="n">i</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Still, using processes is quite different than using threads: in
particular, when using processes you can only yield pickleable values
and you cannot re-raise an exception first raised in a different
process, because traceback objects are not pickleable. Moreover,
you cannot rely on automatic sharing of your objects.</p>
<p>On the plus side, when using processes you do not need to worry about
killing a command: they are killed immediately using a SIGTERM signal,
and there is no <code class="docutils literal notranslate"><span class="pre">TOBEKILLED</span></code> mechanism. Moreover, the killing is
guaranteed to be soft: internally a command receiving a SIGTERM raises
a <code class="docutils literal notranslate"><span class="pre">TerminatedProcess</span></code> exception which is trapped in the generator
loop, so that the command is closed properly.</p>
<p>Using processes allows one to take full advantage of multicore machines
and it is safer than using threads, so it is the recommended approach
unless you are working on Windows.</p>
</div>
<div class="section" id="managing-the-output-of-concurrent-commands">
<h2><a class="toc-backref" href="#id38">Managing the output of concurrent commands</a><a class="headerlink" href="#managing-the-output-of-concurrent-commands" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> acts as a command-line task launcher and can be used as the base
to build a GUI-based task launcher and task monitor. To this aim the
interpreter class provides a <code class="docutils literal notranslate"><span class="pre">.submit</span></code> method which returns a task
object and a <code class="docutils literal notranslate"><span class="pre">.tasks</span></code> method returning the list of all the tasks
submitted to the interpreter.  The <code class="docutils literal notranslate"><span class="pre">submit</span></code> method does not start the task
and thus it is nonblocking.
Each task has an <code class="docutils literal notranslate"><span class="pre">.outlist</span></code> attribute which is a list
storing the value yielded by the generator underlying the task (the
<code class="docutils literal notranslate"><span class="pre">None</span></code> values are skipped though): the <code class="docutils literal notranslate"><span class="pre">.outlist</span></code> grows as the
task runs and more values are yielded. Accessing the <code class="docutils literal notranslate"><span class="pre">.outlist</span></code> is
nonblocking and can be done freely.
Finally there is a <code class="docutils literal notranslate"><span class="pre">.result</span></code>
property which waits for the task to finish and returns the last yielded
value or raises an exception. The code below provides an example of
how you could implement a GUI over the importer example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">Tkinter</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">importer3</span> <span class="kn">import</span> <span class="n">FakeImporter</span>

<span class="k">def</span> <span class="nf">taskwidget</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="s2">&quot;A Label widget showing the output of a task every 500 ms&quot;</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">sv</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">show_outlist</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">outlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="c1"># no output yet</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">sv</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
        <span class="n">root</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="n">show_outlist</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_outlist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lb</span>

<span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">taskwidget</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span>
    <span class="k">with</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">FakeImporter</span><span class="p">))</span> <span class="k">as</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s1">&#39;import_file f1&#39;</span><span class="p">),</span> <span class="n">i</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s1">&#39;import_file f2&#39;</span><span class="p">)]</span>
        <span class="n">monitor</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="experimental-features">
<h1><a class="toc-backref" href="#id39">Experimental features</a><a class="headerlink" href="#experimental-features" title="Permalink to this headline">¶</a></h1>
<p>The distribution of <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> includes a few experimental features which I am
not committed to fully support and that may go away in future versions.
They are included as examples of things that you may build on top of
<a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>: the aim is to give you ideas. Some of the experimental features
might grow to become external projects built on <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a>.</p>
<div class="section" id="parallel-computing-with-plac">
<h2><a class="toc-backref" href="#id40">Parallel computing with plac</a><a class="headerlink" href="#parallel-computing-with-plac" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> is certainly not intended as a tool for parallel computing, but
still you can use it to launch a set of commands and collect the
results, similarly to the MapReduce pattern popularized by
Google.  In order to give an example, I will consider the “Hello
World” of parallel computing, i.e. the computation of pi with
independent processes.  There is a huge number of algorithms to
compute pi; here I will describe a trivial one chosen for simplicity,
not for efficiency. The trick is to consider the first quadrant of a
circle with radius 1 and to extract a number of points <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y)</span></code> with
<code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> random variables in the interval <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code>. The
probability of extracting a number inside the quadrant (i.e. with
<code class="docutils literal notranslate"><span class="pre">x^2</span> <span class="pre">+</span> <span class="pre">y^2</span> <span class="pre">&lt;</span> <span class="pre">1</span></code>) is proportional to the area of the quadrant
(i.e. <code class="docutils literal notranslate"><span class="pre">pi/4</span></code>). The value of <code class="docutils literal notranslate"><span class="pre">pi</span></code> therefore can be extracted by
multiplying by 4 the ratio between the number of points in the
quadrant versus the total number of points <code class="docutils literal notranslate"><span class="pre">N</span></code>, for <code class="docutils literal notranslate"><span class="pre">N</span></code> large:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_pi</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">inside</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
</pre></div>
</div>
<p>The algorithm is trivially parallelizable: if you have n CPUs, you can
compute pi n times with N/n iterations, sum the results and divide the total
by n. I have a Macbook with two cores, therefore I would expect a speedup
factor of 2 with respect to a sequential computation. Moreover, I would
expect a threaded computation to be even slower than a sequential
computation, due to the GIL and the scheduling overhead.</p>
<p>Here is a script implementing the algorithm and working in three different
modes (parallel mode, threaded mode and sequential mode) depending on a
<code class="docutils literal notranslate"><span class="pre">mode</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">plac</span>


<span class="k">class</span> <span class="nc">PiCalculator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute \u03C0 in parallel with threads or processes&quot;&quot;&quot;</span>

    <span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
        <span class="n">npoints</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;number of integration points&#39;</span><span class="p">,</span> <span class="s1">&#39;positional&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;sequential|parallel|threaded&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;SPT&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npoints</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;S&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npoints</span> <span class="o">=</span> <span class="n">npoints</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpcommands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;calc_pi&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thcommands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;calc_pi&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;calc_pi&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">submit_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npoints</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s1">&#39;calc_pi </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">npoints</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span><span class="n">npoints</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npoints&#39;</span><span class="p">,</span> <span class="s1">&#39;positional&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">calc_pi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npoints</span><span class="p">):</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span><span class="p">):</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">M iterations&#39;</span> <span class="o">%</span> <span class="n">n</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">counts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">yield</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">counts</span><span class="p">)</span> <span class="o">/</span> <span class="n">npoints</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">tasks</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># the task was killed</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">PiCalculator</span><span class="p">)</span>
    <span class="n">pc</span><span class="o">.</span><span class="n">submit_tasks</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1"> in </span><span class="si">%f</span><span class="s1"> seconds &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pc</span><span class="o">.</span><span class="n">run</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">pc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal notranslate"><span class="pre">submit_tasks</span></code> method, which instantiates and initializes a
<code class="docutils literal notranslate"><span class="pre">plac.Interpreter</span></code> object and submits a number of commands corresponding
to the number of available CPUs. The <code class="docutils literal notranslate"><span class="pre">calc_pi</span></code> command yields a log
message for each million interactions, in order to monitor the progress of
the computation. The <code class="docutils literal notranslate"><span class="pre">run</span></code> method starts all the submitted commands
in parallel and sums the results. It returns the average value of <code class="docutils literal notranslate"><span class="pre">pi</span></code>
after the slowest CPU has finished its job (if the CPUs are equal and
equally busy they should finish more or less at the same time).</p>
<p>Here are the results on my old Macbook with Ubuntu 10.04 and Python 2.6,
for 10 million of iterations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python picalculator.py -mP 10000000 # two processes
3.141904 in 5.744545 seconds
$ python picalculator.py -mT 10000000 # two threads
3.141272 in 13.875645 seconds
$ python picalculator.py -mS 10000000 # sequential
3.141586 in 11.353841 seconds
</pre></div>
</div>
<p>As you see using processes one gets a 2x speedup indeed, where the threaded
mode is some 20% slower than the sequential mode.</p>
<p>Since the pattern “submit a bunch of tasks, start them and collect the
results” is so common, <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> provides an utility function
<code class="docutils literal notranslate"><span class="pre">runp(genseq,</span> <span class="pre">mode='p')</span></code> to start
a bunch of generators and return a list of results. By default
<code class="docutils literal notranslate"><span class="pre">runp</span></code> use processes, but you can use threads by passing <code class="docutils literal notranslate"><span class="pre">mode='t'</span></code>.
With <code class="docutils literal notranslate"><span class="pre">runp</span></code> the parallel pi calculation becomes a one-liner:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">result</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">plac</span><span class="o">.</span><span class="n">runp</span><span class="p">(</span><span class="n">calc_pi</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)))</span><span class="o">/</span><span class="n">ncpus</span>
</pre></div>
</div>
<p>The file <code class="docutils literal notranslate"><span class="pre">test_runp</span></code> in the <code class="docutils literal notranslate"><span class="pre">doc</span></code> directory of the plac distribution
shows another usage example. Note that if one of the tasks fails
for some reason, you will get the exception object instead of the result.</p>
</div>
<div class="section" id="monitor-support">
<h2><a class="toc-backref" href="#id41">Monitor support</a><a class="headerlink" href="#monitor-support" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> provides experimental support for monitoring the output of
concurrent commands, at least for platforms where multiprocessing is
fully supported. You can define your own monitor class, simply by
inheriting from <code class="docutils literal notranslate"><span class="pre">plac.Monitor</span></code> and overriding the methods
<code class="docutils literal notranslate"><span class="pre">add_listener(self,</span> <span class="pre">taskno)</span></code>, <code class="docutils literal notranslate"><span class="pre">del_listener(self,</span> <span class="pre">taskno)</span></code>,
<code class="docutils literal notranslate"><span class="pre">notify_listener(self,</span> <span class="pre">taskno,</span> <span class="pre">msg)</span></code>, <code class="docutils literal notranslate"><span class="pre">read_queue(self)</span></code>,
<code class="docutils literal notranslate"><span class="pre">start(self)</span></code> and <code class="docutils literal notranslate"><span class="pre">stop(self)</span></code>.  Then you can add a monitor object to
any <code class="docutils literal notranslate"><span class="pre">plac.Interpreter</span></code> object by calling the <code class="docutils literal notranslate"><span class="pre">add_monitor</span></code>
method. For convenience, <code class="docutils literal notranslate"><span class="pre">plac</span></code> comes with a very simple
<code class="docutils literal notranslate"><span class="pre">TkMonitor</span></code> based on Tkinter (I chose Tkinter because it is easy to
use and in the standard library, but you can use any GUI): you
can look at how the <code class="docutils literal notranslate"><span class="pre">TkMonitor</span></code> is implemented in
<code class="docutils literal notranslate"><span class="pre">plac_tk.py</span></code> and adapt it. Here is an usage example of the
<code class="docutils literal notranslate"><span class="pre">TkMonitor</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">import</span> <span class="nn">plac</span>

<span class="k">class</span> <span class="nc">Hello</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">mpcommands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="s1">&#39;hello&#39;</span>
    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="o">.</span><span class="n">Exit</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">Hello</span><span class="p">())</span>
    <span class="n">i</span><span class="o">.</span><span class="n">add_monitor</span><span class="p">(</span><span class="n">plac</span><span class="o">.</span><span class="n">TkMonitor</span><span class="p">(</span><span class="s1">&#39;tkmon&#39;</span><span class="p">))</span>
    <span class="n">i</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>

    
</pre></div>
</div>
<p>Try to run the <code class="docutils literal notranslate"><span class="pre">hello</span></code> command in the interactive interpreter:
each time, a new text widget will be added displaying the output
of the command. Note that if <code class="docutils literal notranslate"><span class="pre">Tkinter</span></code> is not installed correctly
on your system, the <code class="docutils literal notranslate"><span class="pre">TkMonitor</span></code> class will not be available.</p>
</div>
<div class="section" id="the-plac-server">
<h2><a class="toc-backref" href="#id42">The plac server</a><a class="headerlink" href="#the-plac-server" title="Permalink to this headline">¶</a></h2>
<p>A command-line oriented interface can be easily converted into a
socket-based interface. Starting from release 0.7 <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> features a
built-in server which is able to accept commands from multiple clients
and execute them. The server works by instantiating a separate
interpreter for each client, so that if a client interpreter dies for
any reason, the other interpreters keep working.  To avoid external
dependencies the server is based on the <code class="docutils literal notranslate"><span class="pre">asynchat</span></code> module in the
standard library, but it would not be difficult to replace the server
with a different one (for instance, a Twisted server).  Notice that at
the moment the <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> server does not work with to Python 3.2+ due to
changes to <code class="docutils literal notranslate"><span class="pre">asynchat</span></code>. In time I will fix this and other known
issues.  You should consider the server functionality still
experimental and subject to changes. Also, notice that since
<code class="docutils literal notranslate"><span class="pre">asynchat</span></code>-based servers are asynchronous, any blocking command in
the interpreter should be run in a separated process or thread.  The
default port for the <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> server is 2199, and the command to signal
end-of-connection is EOF.  For instance, here is how you could manage
remote import on a database (say a SQLite db):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plac</span>
<span class="kn">from</span> <span class="nn">importer2</span> <span class="kn">import</span> <span class="n">FakeImporter</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">2199</span><span class="p">):</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">FakeImporter</span><span class="p">(</span><span class="s1">&#39;dsn&#39;</span><span class="p">)</span>
    <span class="n">plac</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>You can connect to the server with <code class="docutils literal notranslate"><span class="pre">telnet</span></code> on port 2199, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet localhost 2199
Trying ::1...
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
i&gt; import_file f1
i&gt; .list
&lt;ThreadedTask 1 [import_file f1] RUNNING&gt;
i&gt; .out
Imported 100 lines
Imported 200 lines
i&gt; EOF
Connection closed by foreign host.
</pre></div>
</div>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id43">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Once <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> claimed to be the easiest command-line arguments parser
in the world. Having read this document you may think that it is not
so easy after all. But it is a false impression. Actually the
rules are quite simple:</p>
<ol class="arabic simple">
<li><p>if you want to implement a command-line script, use <code class="docutils literal notranslate"><span class="pre">plac.call</span></code>;</p></li>
<li><p>if you want to implement a command interpreter, use <code class="docutils literal notranslate"><span class="pre">plac.Interpreter</span></code>:</p>
<ul class="simple">
<li><p>for an interactive interpreter, call the <code class="docutils literal notranslate"><span class="pre">.interact</span></code> method;</p></li>
<li><p>for a batch interpreter, call the <code class="docutils literal notranslate"><span class="pre">.execute</span></code> method;</p></li>
</ul>
</li>
<li><p>for testing call the <code class="docutils literal notranslate"><span class="pre">Interpreter.check</span></code> method in the appropriate context
or use the <code class="docutils literal notranslate"><span class="pre">Interpreter.doctest</span></code> feature;</p></li>
<li><p>if you need to go to a lower level, you may need to call the
<code class="docutils literal notranslate"><span class="pre">Interpreter.send</span></code> method which returns a (finished) <code class="docutils literal notranslate"><span class="pre">Task</span></code> object;</p></li>
<li><p>long running commands can be executed in the background as threads or
processes: just declare them in the lists <code class="docutils literal notranslate"><span class="pre">thcommands</span></code> and <code class="docutils literal notranslate"><span class="pre">mpcommands</span></code>
respectively;</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">.start_server</span></code> method starts an asynchronous server on the
given port number (default 2199).</p></li>
</ol>
<p>Moreover, remember that <code class="docutils literal notranslate"><span class="pre">plac_runner.py</span></code> is your friend.</p>
</div>
<hr class="docutils" />
<div class="section" id="appendix-custom-annotation-objects">
<h2><a class="toc-backref" href="#id44">Appendix: custom annotation objects</a><a class="headerlink" href="#appendix-custom-annotation-objects" title="Permalink to this headline">¶</a></h2>
<p>Internally <a class="reference external" href="http://pypi.python.org/pypi/plac">plac</a> uses an <code class="docutils literal notranslate"><span class="pre">Annotation</span></code> class to convert the tuples
in the function signature to annotation objects, i.e. objects with
six attributes: <code class="docutils literal notranslate"><span class="pre">help,</span> <span class="pre">kind,</span> <span class="pre">short,</span> <span class="pre">type,</span> <span class="pre">choices,</span> <span class="pre">metavar</span></code>.</p>
<p>Advanced users can implement their own annotation objects.
For instance, here is an example of how you could implement annotations for
positional arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># annotations.py</span>
<span class="k">class</span> <span class="nc">Positional</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="n">help</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;positional&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abbrev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">choices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metavar</span> <span class="o">=</span> <span class="n">metavar</span>
</pre></div>
</div>
<p>You can use such annotation objects as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example11.py</span>
<span class="kn">import</span> <span class="nn">plac</span>
<span class="kn">from</span> <span class="nn">annotations</span> <span class="kn">import</span> <span class="n">Positional</span>

<span class="nd">@plac</span><span class="o">.</span><span class="n">annotations</span><span class="p">(</span>
    <span class="n">i</span><span class="o">=</span><span class="n">Positional</span><span class="p">(</span><span class="s2">&quot;This is an int&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
    <span class="n">n</span><span class="o">=</span><span class="n">Positional</span><span class="p">(</span><span class="s2">&quot;This is a float&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
    <span class="n">rest</span><span class="o">=</span><span class="n">Positional</span><span class="p">(</span><span class="s2">&quot;Other arguments&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plac</span><span class="p">;</span> <span class="n">plac</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the usage message you get:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">example11</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="n">i</span> <span class="n">n</span> <span class="p">[</span><span class="n">rest</span> <span class="p">[</span><span class="n">rest</span> <span class="o">...</span><span class="p">]]</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">i</span>           <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="nb">int</span>
  <span class="n">n</span>           <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="nb">float</span>
  <span class="n">rest</span>        <span class="n">Other</span> <span class="n">arguments</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>  <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p>You can go on and define <code class="docutils literal notranslate"><span class="pre">Option</span></code> and <code class="docutils literal notranslate"><span class="pre">Flag</span></code> classes, if you like.
Using custom annotation objects you could do advanced things like extracting the
annotations from a configuration file or from a database, but I expect such
use cases to be quite rare: the default mechanism should work
pretty well for most users.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="#">plac</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2010-2021, Michele Simionato.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>